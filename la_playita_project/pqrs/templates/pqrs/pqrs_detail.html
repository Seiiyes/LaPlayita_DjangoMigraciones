{% extends 'core/base.html' %}
{% load static %}
{% load pqrs_extras %}
{% load pqrs_sla_extras %}

{% block title %}{{ pqrs.numero_caso }} - Detalle{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'pqrs/css/pqrs.css' %}">
<style>
    .case-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    .metric-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateX(5px);
    }
    .hover-shadow {
        transition: all 0.3s ease;
    }
    .hover-shadow:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .timeline-modern {
        position: relative;
        padding-left: 30px;
    }
    .timeline-modern::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    .timeline-item-modern {
        position: relative;
        padding-bottom: 2rem;
    }
    .timeline-dot-modern {
        position: absolute;
        left: -24px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid;
        background: white;
    }
    .nav-pills .nav-link {
        border-radius: 50px;
        padding: 0.5rem 1.5rem;
    }
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .action-card {
        border: 2px dashed #dee2e6;
        transition: all 0.3s;
    }
    .action-card:hover {
        border-color: #667eea;
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb bg-light p-3 rounded">
            <li class="breadcrumb-item">
                <a href="{% url 'dashboard' %}"><i class="bi bi-house-door"></i> Inicio</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'pqrs:pqrs_dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard PQRS</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'pqrs:pqrs_list' %}"><i class="bi bi-list-ul"></i> Lista</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {{ pqrs.numero_caso }}
            </li>
        </ol>
    </nav>

    <!-- Flujo Visual del Caso -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body py-3">
            <div class="row text-center align-items-center">
                <!-- Paso 1: Creado -->
                <div class="col">
                    <div class="step-indicator completed">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        <div class="small fw-bold mt-1">Creado</div>
                        <div class="text-muted" style="font-size: 0.75rem;">{{ pqrs.fecha_creacion|date:"d/m H:i" }}</div>
                    </div>
                </div>
                
                <div class="col-auto"><i class="bi bi-arrow-right text-muted"></i></div>
                
                <!-- Paso 2: Asignado -->
                <div class="col">
                    <div class="step-indicator {% if pqrs.asignado_a %}completed{% else %}pending{% endif %}">
                        {% if pqrs.asignado_a %}
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted" style="font-size: 1.5rem;"></i>
                        {% endif %}
                        <div class="small fw-bold mt-1">Asignado</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            {% if pqrs.asignado_a %}{{ pqrs.asignado_a.username }}{% else %}Pendiente{% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-auto"><i class="bi bi-arrow-right text-muted"></i></div>
                
                <!-- Paso 3: En Proceso -->
                <div class="col">
                    <div class="step-indicator {% if pqrs.estado == 'en_proceso' or pqrs.estado == 'resuelto' or pqrs.estado == 'cerrado' %}active{% elif pqrs.estado == 'nuevo' %}pending{% endif %}">
                        {% if pqrs.estado == 'en_proceso' %}
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 1.5rem;"></i>
                        {% elif pqrs.estado == 'resuelto' or pqrs.estado == 'cerrado' %}
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted" style="font-size: 1.5rem;"></i>
                        {% endif %}
                        <div class="small fw-bold mt-1">En Proceso</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            {% if pqrs.estado == 'en_proceso' %}Activo{% elif pqrs.estado == 'nuevo' %}Pendiente{% else %}Completado{% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-auto"><i class="bi bi-arrow-right text-muted"></i></div>
                
                <!-- Paso 4: Resuelto -->
                <div class="col">
                    <div class="step-indicator {% if pqrs.estado == 'resuelto' or pqrs.estado == 'cerrado' %}completed{% else %}pending{% endif %}">
                        {% if pqrs.estado == 'resuelto' or pqrs.estado == 'cerrado' %}
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted" style="font-size: 1.5rem;"></i>
                        {% endif %}
                        <div class="small fw-bold mt-1">Resuelto</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            {% if pqrs.estado == 'resuelto' or pqrs.estado == 'cerrado' %}Completado{% else %}Pendiente{% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-auto"><i class="bi bi-arrow-right text-muted"></i></div>
                
                <!-- Paso 5: Cerrado -->
                <div class="col">
                    <div class="step-indicator {% if pqrs.estado == 'cerrado' %}completed{% else %}pending{% endif %}">
                        {% if pqrs.estado == 'cerrado' %}
                            <i class="bi bi-lock-fill text-secondary" style="font-size: 1.5rem;"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted" style="font-size: 1.5rem;"></i>
                        {% endif %}
                        <div class="small fw-bold mt-1">Cerrado</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            {% if pqrs.fecha_cierre %}{{ pqrs.fecha_cierre|date:"d/m H:i" }}{% else %}Pendiente{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header del Caso -->
    <div class="case-header shadow-lg">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <h2 class="mb-2">
                    <i class="bi bi-ticket-detailed"></i> {{ pqrs.numero_caso }}
                </h2>
                <h4 class="mb-3">{{ pqrs.get_tipo_display }}</h4>
                
                <!-- Indicador SLA prominente -->
                {% if pqrs.fecha_limite_sla %}
                <div class="sla-indicator-header mt-3 p-3 bg-white bg-opacity-25 rounded">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="bi {{ pqrs.fecha_limite_sla|sla_icono }}" style="font-size: 2.5rem;"></i>
                        </div>
                        <div class="col">
                            <h6 class="mb-1 text-white-50">
                                <i class="bi bi-clock-history"></i> Tiempo Límite de Atención
                            </h6>
                            <h4 class="mb-0 {{ pqrs.fecha_limite_sla|sla_color_class }}">
                                {{ pqrs.fecha_limite_sla|tiempo_restante_sla }}
                            </h4>
                            <small>Límite: {{ pqrs.fecha_limite_sla|date:"d/m/Y H:i" }}</small>
                            
                            <!-- Barra de progreso -->
                            <div class="progress mt-2" style="height: 8px;">
                                {% sla_porcentaje pqrs.fecha_creacion pqrs.fecha_limite_sla as porcentaje %}
                                <div class="progress-bar {% if porcentaje >= 100 %}bg-danger{% elif porcentaje >= 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ porcentaje }}%"
                                     aria-valuenow="{{ porcentaje }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="d-flex gap-2 flex-wrap">
                    {% if pqrs.prioridad == 'urgente' %}
                        <span class="badge bg-danger fs-6"><i class="bi bi-exclamation-triangle"></i> {{ pqrs.get_prioridad_display }}</span>
                    {% elif pqrs.prioridad == 'alta' %}
                        <span class="badge bg-warning text-dark fs-6"><i class="bi bi-arrow-up"></i> {{ pqrs.get_prioridad_display }}</span>
                    {% else %}
                        <span class="badge bg-info fs-6">{{ pqrs.get_prioridad_display }}</span>
                    {% endif %}
                    <span class="badge bg-light text-dark fs-6">{{ pqrs.get_categoria_display }}</span>
                    <span class="badge bg-white text-dark fs-6"><i class="bi bi-broadcast"></i> {{ pqrs.get_canal_origen_display }}</span>
                </div>
            </div>
            <div class="text-end">
                <span class="badge {{ pqrs.estado|status_badge }} fs-5 px-4 py-2">
                    {{ pqrs.get_estado_display }}
                </span>
                <div class="mt-3">
                    <a href="{% url 'pqrs:pqrs_list' %}" class="btn btn-light">
                        <i class="bi bi-arrow-left"></i> Volver al Listado
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Asignado a</h6>
                            <h5 class="mb-0">
                                {% if pqrs.asignado_a %}
                                    {{ pqrs.asignado_a.get_full_name|default:pqrs.asignado_a.username }}
                                {% else %}
                                    Sin asignar
                                {% endif %}
                            </h5>
                        </div>
                        <i class="bi bi-person-circle fs-1 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Tiempo Transcurrido</h6>
                            <h5 class="mb-0">
                                {% if pqrs.estado == 'cerrado' and pqrs.tiempo_resolucion_horas and pqrs.tiempo_resolucion_horas > 0 %}
                                    {{ pqrs.tiempo_resolucion_horas }}h
                                {% else %}
                                    {{ pqrs.fecha_creacion|tiempo_transcurrido }}
                                {% endif %}
                            </h5>
                        </div>
                        <i class="bi bi-clock-history fs-1 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Eventos</h6>
                            <h5 class="mb-0">{{ eventos.count }}</h5>
                        </div>
                        <i class="bi bi-list-check fs-1 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Adjuntos</h6>
                            <h5 class="mb-0">{{ adjuntos.count }}</h5>
                        </div>
                        <i class="bi bi-paperclip fs-1 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs de Navegación -->
    <ul class="nav nav-pills mb-4" id="caseTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">
                <i class="bi bi-info-circle"></i> Información
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button">
                <i class="bi bi-clock-history"></i> Timeline
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button">
                <i class="bi bi-lightning"></i> Acciones
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button">
                <i class="bi bi-paperclip"></i> Archivos
            </button>
        </li>
    </ul>

    <!-- Contenido de Tabs -->
    <div class="tab-content" id="caseTabsContent">
        <!-- Tab: Información -->
        <div class="tab-pane fade show active" id="info" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-file-text"></i> Descripción del Caso</h5>
                        </div>
                        <div class="card-body">
                            <p class="lead">{{ pqrs.descripcion }}</p>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-person"></i> Información del Cliente</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><i class="bi bi-person-badge text-primary"></i> <strong>Nombre:</strong><br>{{ pqrs.cliente.nombres }} {{ pqrs.cliente.apellidos }}</p>
                                    <p><i class="bi bi-envelope text-primary"></i> <strong>Email:</strong><br>{{ pqrs.cliente.correo }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><i class="bi bi-card-text text-primary"></i> <strong>Documento:</strong><br>{{ pqrs.cliente.documento }}</p>
                                    <p><i class="bi bi-telephone text-primary"></i> <strong>Teléfono:</strong><br>{{ pqrs.cliente.telefono }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-calendar"></i> Fechas</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Creado:</strong><br>{{ pqrs.fecha_creacion|date:"d/m/Y H:i" }}</p>
                            {% if pqrs.fecha_primera_respuesta %}
                            <p><strong>Primera Respuesta:</strong><br>{{ pqrs.fecha_primera_respuesta|date:"d/m/Y H:i" }}</p>
                            {% endif %}
                            {% if pqrs.fecha_cierre %}
                            <p><strong>Cerrado:</strong><br>{{ pqrs.fecha_cierre|date:"d/m/Y H:i" }}</p>
                            {% endif %}
                        </div>
                    </div>

                    {% if pqrs.estado == 'cerrado' and calificacion %}
                    <div class="card shadow-sm border-warning">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0"><i class="bi bi-star-fill"></i> Calificación</h5>
                        </div>
                        <div class="card-body text-center">
                            <h2 class="text-warning">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= calificacion.puntuacion %}⭐{% endif %}
                                {% endfor %}
                            </h2>
                            <p class="mb-0">{{ calificacion.get_puntuacion_display }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tab: Timeline -->
        <div class="tab-pane fade" id="timeline" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="timeline-modern">
                        {% for evento in eventos %}
                        <div class="timeline-item-modern">
                            <div class="timeline-dot-modern border-{% if evento.tipo_evento == 'creacion' %}success{% elif evento.tipo_evento == 'respuesta' %}primary{% elif evento.tipo_evento == 'estado' %}info{% else %}secondary{% endif %}"></div>
                            <div class="card {% if evento.tipo_evento == 'respuesta' %}border-primary{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                {% if evento.tipo_evento == 'creacion' %}
                                                    <span class="badge bg-success"><i class="bi bi-plus-circle"></i> Caso Creado</span>
                                                {% elif evento.tipo_evento == 'respuesta' %}
                                                    <span class="badge bg-primary"><i class="bi bi-chat-dots"></i> Respuesta al Cliente</span>
                                                    {% if evento.enviado_por_correo %}
                                                        <span class="badge bg-success ms-1"><i class="bi bi-envelope-check"></i> Enviado</span>
                                                    {% else %}
                                                        <span class="badge bg-warning ms-1"><i class="bi bi-envelope-x"></i> No enviado</span>
                                                    {% endif %}
                                                {% elif evento.tipo_evento == 'estado' %}
                                                    <span class="badge bg-info"><i class="bi bi-arrow-repeat"></i> Cambio de Estado</span>
                                                {% else %}
                                                    <span class="badge bg-secondary"><i class="bi bi-sticky"></i> Nota Interna</span>
                                                {% endif %}
                                            </h6>
                                            <p class="mb-1">
                                                <strong>{{ evento.usuario.get_full_name|default:evento.usuario.username }}</strong>
                                                {% if evento.tipo_evento == 'respuesta' and evento.enviado_por_correo and evento.fecha_envio_correo %}
                                                    <small class="text-success">
                                                        <i class="bi bi-clock"></i> Enviado el {{ evento.fecha_envio_correo|date:"d/m/Y H:i" }}
                                                    </small>
                                                {% endif %}
                                            </p>
                                            {% if evento.comentario %}
                                                {% if evento.tipo_evento == 'respuesta' %}
                                                    <div class="bg-light p-3 rounded mt-2">
                                                        <h6 class="text-primary mb-2"><i class="bi bi-chat-quote"></i> Respuesta enviada:</h6>
                                                        <p class="mb-0" style="white-space: pre-wrap;">{{ evento.comentario }}</p>
                                                    </div>
                                                {% else %}
                                                    <p class="mb-0 text-muted" style="white-space: pre-wrap;">{{ evento.comentario }}</p>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted">{{ evento.fecha_evento|date:"d/m/Y H:i" }}</small>
                                            {% if evento.tipo_evento == 'respuesta' and evento.es_visible_cliente %}
                                                <br><small class="text-primary"><i class="bi bi-eye"></i> Visible al cliente</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Acciones -->
        <div class="tab-pane fade" id="actions" role="tabpanel">
            <div class="row">
                <!-- Asignar -->
                <div class="col-md-6 mb-4">
                    <div class="card action-card h-100">
                        <div class="card-body">
                            <h5><i class="bi bi-person-check text-primary"></i> Asignar Caso</h5>
                            <form method="post" action="{% url 'pqrs:pqrs_asignar' pqrs.id %}">
                                {% csrf_token %}
                                {{ asignar_form.asignado_a }}
                                <button type="submit" class="btn btn-primary w-100 mt-2">Asignar</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Responder -->
                <div class="col-md-6 mb-4">
                    <div class="card action-card h-100">
                        <div class="card-body">
                            <h5><i class="bi bi-envelope text-success"></i> Responder al Cliente</h5>
                            <form method="post" action="{% url 'pqrs:pqrs_update' pqrs.id %}" id="respuestaForm">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="id_respuesta" class="form-label">Respuesta para el Cliente</label>
                                    <textarea name="respuesta" class="form-control" rows="5" 
                                              placeholder="✍️ Escriba aquí la respuesta que se enviará por correo al cliente..." 
                                              required id="id_respuesta"></textarea>
                                </div>
                                <button type="submit" name="action" value="save_response" class="btn btn-success w-100 mt-2" id="btnEnviarRespuesta">
                                    <i class="bi bi-send"></i> Enviar Respuesta
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Cambiar Estado -->
                {% if pqrs.estado != 'cerrado' %}
                <div class="col-md-12">
                    <div class="card action-card">
                        <div class="card-body">
                            <h5><i class="bi bi-arrow-repeat text-warning"></i> Cambiar Estado</h5>
                            
                            <!-- Estado actual -->
                            <div class="alert alert-info mb-3">
                                <strong>Estado actual:</strong> 
                                <span class="badge 
                                    {% if pqrs.estado == 'nuevo' %}bg-primary
                                    {% elif pqrs.estado == 'en_proceso' %}bg-warning
                                    {% elif pqrs.estado == 'resuelto' %}bg-success
                                    {% else %}bg-secondary{% endif %}">
                                    {{ pqrs.get_estado_display }}
                                </span>
                            </div>
                            
                            <form method="post" action="{% url 'pqrs:pqrs_update' pqrs.id %}" id="estadoForm">
                                {% csrf_token %}
                                <input type="hidden" name="action" id="actionInput" value="">
                                {{ form.observacion_estado }}
                                <div class="d-flex gap-2 mt-3">
                                    {% if pqrs.estado == 'nuevo' %}
                                        <button type="button" data-action="start_processing" class="btn btn-warning estado-btn">
                                            <span class="btn-text"><i class="bi bi-play-circle"></i> Iniciar Proceso</span>
                                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        </button>
                                    {% elif pqrs.estado == 'en_proceso' %}
                                        <button type="button" data-action="resolve" class="btn btn-success estado-btn">
                                            <span class="btn-text"><i class="bi bi-check-circle"></i> Marcar Resuelto</span>
                                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        </button>
                                    {% elif pqrs.estado == 'resuelto' %}
                                        <div class="alert alert-success mb-3">
                                            <i class="bi bi-check-circle-fill"></i> Este caso ha sido marcado como resuelto. 
                                            Puede cerrarlo definitivamente o reabrirlo si es necesario.
                                        </div>
                                    {% endif %}
                                    
                                    {% if pqrs.estado != 'resuelto' %}
                                        <button type="button" data-action="close" class="btn btn-danger estado-btn">
                                            <span class="btn-text"><i class="bi bi-x-circle"></i> Cerrar Caso</span>
                                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        </button>
                                    {% else %}
                                        <button type="button" data-action="close" class="btn btn-danger estado-btn">
                                            <span class="btn-text"><i class="bi bi-lock"></i> Cerrar Definitivamente</span>
                                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        </button>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tab: Archivos -->
        <div class="tab-pane fade" id="files" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-upload"></i> Subir Archivo</h5>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="file" class="form-control mb-3" id="archivo" name="archivo">
                                <input type="text" class="form-control mb-3" name="descripcion" placeholder="Descripción (opcional)">
                                <button type="submit" class="btn btn-primary w-100">Subir</button>
                            </form>
                            <div id="uploadMessage" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-files"></i> Archivos Adjuntos</h5>
                        </div>
                        <div class="card-body">
                            {% if adjuntos %}
                                {% for adjunto in adjuntos %}
                                <div class="d-flex align-items-center mb-3 p-2 border rounded hover-shadow">
                                    <i class="bi bi-file-earmark-{% if 'image' in adjunto.tipo_mime %}image{% elif 'pdf' in adjunto.tipo_mime %}pdf{% else %}text{% endif %} fs-3 text-primary me-3"></i>
                                    <div class="flex-grow-1">
                                        <strong>{{ adjunto.nombre_archivo }}</strong><br>
                                        <small class="text-muted">
                                            {{ adjunto.tamano_bytes|filesizeformat }} • 
                                            Subido por {{ adjunto.subido_por.get_full_name|default:adjunto.subido_por.username }} • 
                                            {{ adjunto.fecha_subida|date:"d/m/Y H:i" }}
                                        </small>
                                        {% if adjunto.descripcion %}
                                        <br><small class="text-muted"><i class="bi bi-chat-left-text"></i> {{ adjunto.descripcion }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="btn-group">
                                        <a href="/media/{{ adjunto.ruta_archivo }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Ver archivo">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/media/{{ adjunto.ruta_archivo }}" download class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Descargar">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center">No hay archivos adjuntos</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevenir múltiples envíos en formulario de cambio de estado
    const estadoForm = document.getElementById('estadoForm');
    if (estadoForm) {
        let isSubmitting = false;
        const actionInput = document.getElementById('actionInput');
        
        // Manejar clicks en botones de estado
        estadoForm.querySelectorAll('.estado-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Verificar que haya observación
                const observacion = estadoForm.querySelector('[name="observacion_estado"]');
                if (!observacion || !observacion.value.trim()) {
                    alert('Debe proporcionar una observación para el cambio de estado.');
                    return false;
                }
                
                // Verificar si ya se está enviando
                if (isSubmitting) {
                    return false;
                }
                
                // Marcar como enviando
                isSubmitting = true;
                
                // Establecer la acción en el campo oculto
                const action = this.getAttribute('data-action');
                actionInput.value = action;
                
                // Deshabilitar el botón
                this.disabled = true;
                
                // Ocultar texto y mostrar spinner
                const btnText = this.querySelector('.btn-text');
                const spinner = this.querySelector('.spinner-border');
                if (btnText) btnText.classList.add('d-none');
                if (spinner) spinner.classList.remove('d-none');
                
                // Deshabilitar todos los botones de estado
                estadoForm.querySelectorAll('.estado-btn').forEach(b => b.disabled = true);
                
                // Enviar el formulario
                estadoForm.submit();
            });
        });
    }
    
    // Formulario de respuesta funciona sin JavaScript adicional
    
    // Solo prevenir múltiples envíos en formularios específicos (NO en respuestaForm)
    const allForms = document.querySelectorAll('form');
    allForms.forEach(form => {
        // EXCLUIR explícitamente el formulario de respuesta
        if (form.id !== 'estadoForm' && form.id !== 'uploadForm' && form.id !== 'respuestaForm') {
            let formSubmitting = false;
            form.addEventListener('submit', function(e) {
                if (formSubmitting) {
                    e.preventDefault();
                    return false;
                }
                formSubmitting = true;
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Procesando...';
                }
            });
        }
    });
    
    // Upload form
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(uploadForm);
            const archivo = document.getElementById('archivo').files[0];
            
            if (!archivo) {
                document.getElementById('uploadMessage').innerHTML = '<div class="alert alert-warning">Seleccione un archivo</div>';
                return;
            }
            
            try {
                const response = await fetch('{% url "pqrs:pqrs_upload_adjunto" pqrs.id %}', {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('uploadMessage').innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    document.getElementById('uploadMessage').innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                }
            } catch (error) {
                document.getElementById('uploadMessage').innerHTML = '<div class="alert alert-danger">Error al subir</div>';
            }
        });
    }
});
</script>
{% endblock %}
