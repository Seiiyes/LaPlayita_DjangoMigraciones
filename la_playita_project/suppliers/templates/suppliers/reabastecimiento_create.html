{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Solicitar Reabastecimiento{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<link rel="stylesheet" href="{% static 'suppliers/css/reabastecimiento.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">Crear Nueva Orden de Reabastecimiento</h2>
                    <a href="{% url 'suppliers:reabastecimiento_list' %}" class="btn btn-close btn-close-white" aria-label="Cerrar"></a>
                </div>
                <div class="card-body p-lg-4">
                    <form method="post" action="{% url 'suppliers:reabastecimiento_create' %}" id="reabastecimientoForm" data-formset-prefix="{{ formset.prefix }}">
                        {% csrf_token %}
                        <input type="hidden" name="estado" value="solicitado">

                        <!-- Sticky Header con Resumen -->
                        <div class="sticky-top bg-white p-3 mb-4 border-bottom shadow-sm" style="margin: -1rem -1rem 0 -1rem; z-index: 10; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);" role="region" aria-label="Resumen de orden">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <small class="text-muted d-block fw-bold"><i class="fas fa-building me-1"></i>Proveedor</small>
                                    <strong id="proveedor-display" class="fs-5 text-primary" aria-live="polite" style="display: block; margin-top: 0.25rem;">Seleccionar...</strong>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted d-block fw-bold"><i class="fas fa-calculator me-1"></i>Total Estimado</small>
                                    <strong id="total-display" class="fs-5 text-success" aria-live="polite" style="display: block; margin-top: 0.25rem;">$0</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Alerta de validación (inicialmente oculta) -->
                        <div id="formValidationAlert" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
                            <strong><i class="fas fa-exclamation-circle me-2"></i>Errores en el formulario:</strong>
                            <ul id="formErrorsList" class="mb-0 mt-2"></ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                        </div>

                        <h5 class="text-secondary mb-3">Información General</h5>
                        <div class="p-3 border rounded-3 bg-light mb-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" for="id_proveedor_select">{{ form.proveedor.label }}</label>
                                    <div class="input-group">
                                        {% render_field form.proveedor class="form-select select2-field" required="required" id="id_proveedor_select" aria-label="Seleccionar proveedor" aria-describedby="proveedor-help" %}
                                        <button type="button" class="btn btn-outline-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#nuevoProveedorModal" title="Crear Nuevo Proveedor" aria-label="Crear nuevo proveedor">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <small id="proveedor-help" class="form-text text-muted d-block mt-1">Selecciona un proveedor existente o crea uno nuevo</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">{{ form.forma_pago.label }}</label>
                                    {{ form.forma_pago }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">{{ form.observaciones.label }}</label>
                                    {{ form.observaciones }}
                                </div>
                            </div>
                        </div>

                        <h5 class="text-secondary mb-3">Detalles de Productos</h5>
                        <div class="border rounded-3 p-3 mb-4" id="detalle-formset-container">
                            {{ formset.management_form }}
                            <div class="table-responsive">
                                <table class="table" id="detalleTable" style="font-size: 0.95rem;" role="grid" aria-label="Detalles de productos a reabastecerse">
                                    <thead class="table-light">
                                        <tr role="row">
                                            <th style="width: 30%;" role="columnheader">Producto</th>
                                            <th class="text-center" style="width: 10%;" role="columnheader">Cantidad</th>
                                            <th class="text-center" style="width: 15%;" role="columnheader">Costo Unit.</th>
                                            <th class="text-center" style="width: 10%;" role="columnheader">IVA (%)</th>
                                            <th class="text-center" style="width: 18%;" role="columnheader">Caducidad</th>
                                            <th class="text-center" style="width: 8%;" role="columnheader">Acción</th>
                                            <th class="d-none">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for f in formset.forms %}
                                        <tr class="formset-row" id="detalle-row-{{ forloop.counter0 }}" style="height: 60px; vertical-align: middle;" role="row">
                                            <td role="gridcell">{% render_field f.producto class="form-select select2-field producto-select" style="font-size: 1rem; padding: 0.6rem;" aria-label="Producto fila {{ forloop.counter }}" %}</td>
                                            <td class="text-center" role="gridcell">{% render_field f.cantidad class="form-control cantidad-input text-center" required="required" style="font-size: 1rem; padding: 0.6rem;" aria-label="Cantidad fila {{ forloop.counter }}" %}</td>
                                            <td class="text-center" role="gridcell">{% render_field f.costo_unitario class="form-control costo-unitario-input text-center" required="required" style="font-size: 1rem; padding: 0.6rem;" aria-label="Costo unitario fila {{ forloop.counter }}" %}</td>
                                            <td class="text-center" role="gridcell">
                                                <select name="{{ f.iva.name }}" class="form-select iva-porcentaje-input text-center" style="font-size: 1rem; padding: 0.6rem;" aria-label="IVA fila {{ forloop.counter }}">
                                                    <option value="0" {% if f.iva.value == '0' or f.iva.value == 0 %}selected{% endif %}>0%</option>
                                                    <option value="5" {% if f.iva.value == '5' or f.iva.value == 5 %}selected{% endif %}>5%</option>
                                                    <option value="8" {% if f.iva.value == '8' or f.iva.value == 8 %}selected{% endif %}>8%</option>
                                                    <option value="19" {% if f.iva.value == '19' or f.iva.value == 19 %}selected{% endif %}>19%</option>
                                                </select>
                                            </td>
                                            <td class="text-center" role="gridcell">{% render_field f.fecha_caducidad class="form-control" required="required" style="font-size: 1rem; padding: 0.6rem;" aria-label="Fecha de caducidad fila {{ forloop.counter }}" %}</td>
                                            <td class="text-center" role="gridcell">
                                                <span class="d-none">{% if formset.can_delete %}{{ f.DELETE }}{% endif %}</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" title="Eliminar producto fila {{ forloop.counter }}" aria-label="Eliminar producto fila {{ forloop.counter }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                            <td class="d-none">
                                                <span class="subtotal-display">0.00</span>
                                                <span class="iva-display">0.00</span>
                                                <span class="total-row-display">0.00</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <table style="display:none;">
                                <tbody id="empty-form-template">
                                    <tr class="formset-row" role="row">
                                        {% with ef=formset.empty_form %}
                                        <td role="gridcell">{% render_field ef.producto class="form-select form-select-sm select2-field producto-select" style="font-size: 1rem; padding: 0.6rem;" %}</td>
                                        <td role="gridcell">{% render_field ef.cantidad class="form-control form-control-sm cantidad-input text-center" style="font-size: 1rem; padding: 0.6rem;" %}</td>
                                        <td role="gridcell">{% render_field ef.costo_unitario class="form-control form-control-sm costo-unitario-input text-center" style="font-size: 1rem; padding: 0.6rem;" %}</td>
                                        <td role="gridcell">
                                            <select name="{{ ef.iva.name }}" class="form-select form-select-sm iva-porcentaje-input text-center" style="font-size: 1rem; padding: 0.6rem;">
                                                <option value="0">0%</option>
                                                <option value="5">5%</option>
                                                <option value="8">8%</option>
                                                <option value="19">19%</option>
                                            </select>
                                        </td>
                                        <td role="gridcell">{% render_field ef.fecha_caducidad class="form-control form-control-sm" style="font-size: 1rem; padding: 0.6rem;" %}</td>
                                        <td class="text-center" role="gridcell">
                                            <span class="d-none">{% if formset.can_delete %}{{ ef.DELETE }}{% endif %}</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" title="Eliminar producto" aria-label="Eliminar producto">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                        <td class="d-none">
                                            <span class="subtotal-display">0.00</span>
                                            <span class="iva-display">0.00</span>
                                            <span class="total-row-display">0.00</span>
                                        </td>
                                        {% endwith %}
                                    </tr>
                                </tbody>
                            </table>
                            <div class="d-flex justify-content-between mt-3 gap-2">
                                <button type="button" class="btn btn-outline-primary" id="add-row-formset" aria-label="Agregar una nueva fila de producto">
                                    <i class="fas fa-plus me-2"></i>Agregar Producto
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#nuevoProductoModal" aria-label="Crear un nuevo producto">
                                    <i class="fas fa-box me-2"></i>Nuevo Producto
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Total de productos: <strong id="product-count">0</strong>
                            </small>
                        </div>

                        <!-- Sticky Footer con Resumen y Botones -->
                        <div class="sticky-bottom bg-light p-4 border-top shadow-lg" style="margin: 0 -1rem -1rem -1rem; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);" role="region" aria-label="Resumen y acciones">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-6">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <small class="text-muted d-block fw-bold">Subtotal</small>
                                            <strong id="gran-subtotal" class="fs-5" aria-live="polite" style="color: #495057;">$0</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block fw-bold">IVA</small>
                                            <strong id="gran-iva" class="fs-5" aria-live="polite" style="color: #495057;">$0</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted d-block fw-bold">Total a Pagar</small>
                                    <strong id="gran-total" class="fs-4 text-success" aria-live="polite" style="display: block; margin-top: 0.25rem;">$0</strong>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="cancelarBtn" aria-label="Cancelar y volver a la lista" style="font-weight: 600;">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="submit" class="btn btn-success btn-lg" id="guardarReabastecimientoBtn" aria-label="Guardar solicitud de reabastecimiento" title="Completa todos los campos para guardar" style="font-weight: 600;">
                                    <i class="fas fa-save me-2"></i> Guardar Solicitud
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'suppliers/_modal_nuevo_proveedor.html' %}
{% include 'suppliers/_modal_nuevo_producto.html' %}
{% include 'inventory/_nueva_categoria_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
    const productos = JSON.parse('{{ all_products_json|default:"[]"|escapejs }}');
    // URLs for AJAX calls
    const searchSuppliersUrl = "{{ search_suppliers_url }}";
    const searchProductsUrl = "{{ search_products_url }}";
    // URL for cancel button
    const cancelUrl = "{% url 'suppliers:reabastecimiento_list' %}";
</script>
<script src="{% static 'suppliers/js/reabastecimiento_create.js' %}"></script>
{% endblock %}
