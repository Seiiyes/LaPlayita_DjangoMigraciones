{% extends "core/base.html" %}
{% load static %}

{% block title %}Detalle de Canje #{{ canje.id }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- Card principal de éxito -->
            <div class="card shadow-lg border-success mb-4">
                <div class="card-header bg-success text-white text-center py-3">
                    <h3 class="mb-0">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        ¡Canje Realizado Exitosamente!
                    </h3>
                </div>

                <div class="card-body p-4">
                    <!-- Código del canje -->
                    <div class="text-center mb-4">
                        <h2 class="text-success mb-1">Canje #{{ canje.id }}</h2>
                        <p class="text-muted">
                            <i class="bi bi-calendar-check"></i>
                            {{ canje.fecha_canje|date:"d/m/Y H:i" }}
                        </p>
                    </div>

                    <hr class="my-4">

                    <!-- Información del producto y puntos -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">
                                        <i class="bi bi-box-seam"></i> Producto Canjeado
                                    </h5>
                                    <p class="card-text mb-2">
                                        <strong class="fs-5">{{ canje.producto.nombre }}</strong>
                                    </p>
                                    {% if canje.producto.descripcion %}
                                    <p class="text-muted small mb-0">
                                        {{ canje.producto.descripcion }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-danger">
                                        <i class="bi bi-star-fill"></i> Puntos Utilizados
                                    </h5>
                                    <p class="card-text mb-2">
                                        <strong class="fs-3 text-danger">
                                            -{{ canje.puntos_gastados }} pts
                                        </strong>
                                    </p>
                                    <p class="text-muted small mb-0">
                                        Descontados de tu saldo
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del cliente -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h5 class="card-title text-info">
                                <i class="bi bi-person-circle"></i> Información del Cliente
                            </h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="mb-2">
                                        <strong>Nombre:</strong>
                                        {{ canje.cliente.nombres }} {{ canje.cliente.apellidos }}
                                    </p>
                                    <p class="mb-2">
                                        <strong>Email:</strong>
                                        {{ canje.cliente.correo|default:"No registrado" }}
                                    </p>
                                    <p class="mb-0">
                                        <strong>Documento:</strong>
                                        {{ canje.cliente.documento }}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-info fs-6 px-3 py-2">
                                        <i class="bi bi-wallet2"></i>
                                        {{ canje.cliente.puntos_totales }} pts
                                    </span>
                                    <p class="small text-muted mt-1 mb-0">Puntos restantes</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado del canje -->
                    <div class="text-center mb-4">
                        <span class="badge 
                            {% if canje.estado == 'completado' %}bg-success
                            {% elif canje.estado == 'pendiente' %}bg-warning text-dark
                            {% else %}bg-secondary{% endif %} 
                            px-4 py-2 fs-5">
                            <i class="bi bi-info-circle-fill"></i>
                            Estado: {{ canje.get_estado_display }}
                        </span>
                    </div>

                    <hr class="my-4">

                    <!-- Botones de acción -->
                    <div class="d-grid gap-3">
                        {% if puede_enviar_correo %}
                        <button type="button" class="btn btn-primary btn-lg" id="btnEnviarCorreo">
                            <i class="bi bi-envelope-fill me-2"></i>
                            Enviar Confirmación por Correo
                        </button>
                        {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            No se puede enviar correo: el cliente no tiene email registrado.
                        </div>
                        {% endif %}

                        <a href="{% url 'clients:panel_puntos' canje.cliente.id %}"
                            class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-arrow-left-circle me-2"></i>
                            Volver al Panel de Puntos del Cliente
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para enviar correo con AJAX -->
{% if puede_enviar_correo %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const btnEnviarCorreo = document.getElementById('btnEnviarCorreo');

        if (btnEnviarCorreo) {
            btnEnviarCorreo.addEventListener('click', function () {
                const btn = this;
                const originalHTML = btn.innerHTML;

                // Deshabilitar botón y mostrar loading
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';

                fetch("{% url 'clients:enviar_correo_canje' canje.id %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Cambiar estilo del botón a éxito
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-success');
                            btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Correo Enviado a ' + data.email;

                            // Mostrar alerta de éxito
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                            alertDiv.innerHTML = `
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Correo de confirmación enviado exitosamente a <strong>${data.email}</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                            btn.parentElement.insertBefore(alertDiv, btn);

                            // Auto-cerrar después de 5 segundos
                            setTimeout(() => {
                                alertDiv.remove();
                            }, 5000);
                        } else {
                            throw new Error(data.error || 'Error desconocido al enviar correo');
                        }
                    })
                    .catch(error => {
                        // Restaurar botón y mostrar error
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;

                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                        alertDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Error al enviar el correo: ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                        btn.parentElement.insertBefore(alertDiv, btn);
                    });
            });
        }
    });
</script>
{% endif %}
{% endblock %}