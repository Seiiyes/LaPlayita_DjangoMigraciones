{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}
{% load auth_extras %}
{% load currency_format %}

{% block title %}Inventario de Productos{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'inventory/css/inventario.css' %}">
{% endblock %}

{% block content %}
<div class="container-lg mt-4">
    <div class="row g-3"> <!-- Usar g-3 para espaciado en la fila -->
        <!-- Product List (3 Columnas en pantallas grandes) -->
        <div class="col-lg-3 col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Productos</h5>
                    {% if user|has_role:"Administrador" %}
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#productModal" data-action="new">
                        <i class="bi bi-plus-lg"></i> Nuevo
                    </button>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- B煤squeda/Filtro -->
                    <div class="row g-2 mb-3">
                        <div class="col-12">
                            <input type="text" id="product-search" class="form-control" placeholder="Buscar producto...">
                        </div>
                        <div class="col-6">
                            <select id="category-filter" class="form-select">
                                <option value="all">Categor铆as</option>
                                {% for categoria in categorias %}
                                    <option value="{{ categoria.nombre }}">{{ categoria.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <select id="stock-level-filter" class="form-select">
                                <option value="all">Stock</option>
                                <option value="low">Bajo Stock</option>
                                <option value="out">Agotado</option>
                            </select>
                        </div>
                    </div>
                    <div class="list-group flex-grow-1" id="product-list" style="overflow-y: auto; height: 60vh;">
                        {% for producto in productos %}
                        <a href="#" class="list-group-item list-group-item-action product-item
                            {% if producto.stock_actual <= producto.stock_minimo and producto.stock_actual > 0 %}low-stock{% endif %}
                            {% if producto.stock_actual == 0 %}out-of-stock{% endif %}"
                           data-product-id="{{ producto.pk }}" 
                           data-stock-actual="{{ producto.stock_actual }}"
                           data-stock-minimo="{{ producto.stock_minimo }}"
                           data-category="{{ producto.categoria.nombre }}">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">
                                    {% if producto.stock_actual <= producto.stock_minimo and producto.stock_actual > 0 %}
                                        <span class="alert-icon">锔</span>
                                    {% elif producto.stock_actual == 0 %}
                                        <span class="alert-icon"></span>
                                    {% endif %}
                                    {{ producto.nombre }}
                                </h6>
                                <span class="badge rounded-pill bg-secondary stock-badge-{{ producto.pk }}">{{ producto.stock_actual|default:0|intcomma }}</span>
                            </div>
                            <small class="text-muted">{{ producto.categoria.nombre }}</small>
                            <div class="stock-bar-container">
                                <div class="stock-bar"></div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Details (9 Columnas en pantallas grandes) -->
        <div class="col-lg-9 col-md-8">
            <div id="product-details-container" class="card">
                <!-- Contenido por defecto -->
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div class="text-center">
                        <i class="bi bi-box-seam" style="font-size: 6rem; color: #e0e0e0;"></i>
                        <h4 class="mt-3 text-muted">Seleccione un producto para ver los detalles</h4>
                        <p class="text-muted">Aqu铆 podr谩 ver el stock, los precios y los lotes asociados.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal (for New and Edit) - Se asume que este modal contiene el formulario -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" method="post" novalidate>
                    {% csrf_token %}
                    {% include 'inventory/producto_form_fields.html' with form=form %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="saveProduct" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>

{% include 'inventory/_nueva_categoria_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productDetailsContainer = document.getElementById('product-details-container');
        const productModal = new bootstrap.Modal(document.getElementById('productModal'));
        const productForm = document.getElementById('productForm');
        const productSearch = document.getElementById('product-search');
        const categoryFilter = document.getElementById('category-filter');
        const stockLevelFilter = document.getElementById('stock-level-filter');
        const productList = document.getElementById('product-list');
        const nuevaCategoriaModal = new bootstrap.Modal(document.getElementById('nuevaCategoriaModal'));
        const guardarCategoriaBtn = document.getElementById('guardarCategoriaBtn');
        const nombreCategoriaInput = document.getElementById('nombreCategoria');

        function openProductModal(action, productData = null) {
            const modalTitle = document.getElementById('productModalLabel');
            const productForm = document.getElementById('productForm');
            productForm.reset(); // Resetear el formulario

            if (action === 'new') {
                modalTitle.textContent = 'Nuevo Producto';
                productForm.action = "{% url 'inventory:producto_create_ajax' %}";
            } else if (action === 'edit' && productData) {
                modalTitle.textContent = 'Editar Producto';
                productForm.action = "{% url 'inventory:producto_update' 0 %}".replace('0', productData.id); // Set the correct update URL

                // Fetch full product details for editing
                fetch("{% url 'inventory:producto_detail_json' 0 %}".replace('0', productData.id))
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('id_nombre').value = data.nombre;
                        document.getElementById('id_precio_unitario').value = data.precio_unitario;
                        document.getElementById('id_descripcion').value = data.descripcion;
                        document.getElementById('id_stock_minimo').value = data.stock_minimo;
                        document.getElementById('id_categoria').value = data.categoria_id;
                        productModal.show(); // Show modal after data is loaded
                    })
                    .catch(error => {
                        console.error('Error fetching product details for edit:', error);
                        Swal.fire('Error', 'No se pudieron cargar los detalles del producto para editar.', 'error');
                    });
                return; // Exit to prevent modal.show() from being called twice
            }
            productModal.show(); // Show modal for 'new' action
        }

        async function renderProductDetails(data) {
            // Stock Status
            let stockClass = 'text-success';
            let stockIcon = '<i class="bi bi-check-circle"></i>';

            if (data.stock_actual <= data.stock_minimo) {
                stockClass = 'text-warning';
                stockIcon = '<i class="bi bi-exclamation-circle"></i>';
                if (data.stock_actual === 0) {
                    stockClass = 'text-danger';
                    stockIcon = '<i class="bi bi-exclamation-triangle"></i>';
                }
            }

            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            function formatCurrency(value) {
                if (!value) return '$ 0';
                return new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            let lotesHtml = `<p class="text-center text-muted mt-4">No hay lotes registrados para este producto.</p>`;
            if (data.lotes && data.lotes.length > 0) {
                lotesHtml = `
                    <div class="table-responsive" style="max-height: 40vh; overflow-y: auto;">
                        <table class="table table-sm table-hover table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th># Lote</th>
                                    <th>Cant. Disp.</th>
                                    <th>Costo Unit.</th>
                                    <th>Fecha Cad.</th>
                                    <th>Proveedor</th>
                                    {% if user|has_role:"Administrador" %}
                                    <th>Acciones</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.lotes.map(lote => `
                                    <tr>
                                        <td>${lote.numero_lote}</td>
                                        <td>${lote.cantidad_disponible}</td>
                                        <td>${formatCurrency(lote.costo_unitario_lote)}</td>
                                        <td>${formatDate(lote.fecha_caducidad)}</td>
                                        <td>${lote.proveedor}</td>
                                        {% if user|has_role:"Administrador" %}
                                        <td>
                                            <a href="/inventory/lote/${lote.id}/descartar/" 
                                               class="btn btn-sm btn-outline-danger" 
                                               title="Descartar productos">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                        {% endif %}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            let movimientosHtml = `<p class="text-center text-muted mt-4">No hay movimientos registrados para este producto.</p>`;
            if (data.movimientos && data.movimientos.length > 0) {
                movimientosHtml = `
                    <div class="table-responsive" style="max-height: 40vh; overflow-y: auto;">
                        <table class="table table-sm table-hover table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Descripci贸n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.movimientos.map(m => `
                                    <tr>
                                        <td>${m.fecha_movimiento}</td>
                                        <td>${m.tipo_movimiento}</td>
                                        <td>${m.cantidad}</td>
                                        <td>${m.descripcion}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            productDetailsContainer.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">${data.nombre}</h4>
                    {% if user|has_role:"Administrador" %}
                    <div>
                        <button class="btn btn-warning btn-sm edit-product-btn" data-product-id="${data.id}"><i class="bi bi-pencil"></i> Editar Producto</button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <p class="text-muted mb-1"><strong>Categor铆a:</strong> ${data.categoria}</p>
                            <p class="text-muted mb-1"><strong>ltimo Proveedor:</strong> ${data.ultimo_proveedor}</p>
                            <p>${data.descripcion || ''}</p>
                        </div>
                    </div>

                    <div class="row text-center g-3 mb-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-muted">Precio de Venta</h6>
                                    <p class="card-text fs-4 fw-bold text-success">${formatCurrency(data.precio_unitario)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="text-muted">Stock Actual</h6>
                                    <p class="mb-0 fs-4 fw-bold ${stockClass}">${stockIcon} ${data.stock_actual || 0}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="text-muted">Stock M铆nimo</h6>
                                    <p class="mb-0 fs-4">${data.stock_minimo || 0}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="text-muted">Costo Promedio</h6>
                                    <p class="mb-0 fs-4">${formatCurrency(data.costo_promedio)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mt-4">Lotes del Producto</h5>
                            </div>
                            ${lotesHtml}
                        </div>
                        <div class="col-md-6">
                            <h5 class="mt-4">Movimientos de Inventario</h5>
                            ${movimientosHtml}
                        </div>
                    </div>
                </div>
            `;

            // Agregar event listener para los botones de edici贸n en los detalles
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openProductModal('edit', data);
                });
            });
        }

        // Funci贸n para cargar los detalles del producto usando AJAX
        async function loadProductDetails(productId) {
            const productDetailsContainer = document.getElementById('product-details-container');

            // Mostrar spinner mientras se carga
            productDetailsContainer.innerHTML = `
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>`;

            try {
                // La funci贸n del backend ya fue corregida para no lanzar error 500 por nulos
                const response = await fetch(`/inventory/producto/${productId}/lotes/`);
                
                if (!response.ok) {
                    // Manejo del Error 4xx/5xx (si el backend falla por otra raz贸n o el 500 persiste)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                renderProductDetails(data);
                // Si la edici贸n fue exitosa, actualizamos la lista con los nuevos datos
                updateProductListItem(data);

            } catch (error) {
                console.error('Error loading product details:', error);
                // Mostrar mensaje de error (mejorado con un icono de Bootstrap Icons)
                productDetailsContainer.innerHTML = `
                    <div class="card-body text-center">
                        <i class="bi bi-wifi-off" style="font-size: 4rem; color: #dc3545;"></i>
                        <h5 class="text-danger mt-3">Error al cargar los detalles.</h5>
                        <p class="text-muted">Por favor, revise su conexi贸n o intente de nuevo m谩s tarde. (Detalle: ${error.message})</p>
                    </div>`;
                // Se asume que Swal.fire est谩 disponible
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', 'No se pudieron cargar los detalles del producto.', 'error');
                }
            }
        }

        // Nueva funci贸n para actualizar la lista de productos (despu茅s de una edici贸n/creaci贸n)
        function updateProductListItem(data) {
            const item = document.querySelector(`.product-item[data-product-id="${data.id}"]`);
            if (item) {
                // Actualiza los valores internos
                item.querySelector('h6').textContent = data.nombre;
                item.querySelector('small').textContent = data.categoria;
                const badge = item.querySelector('.stock-badge');
                if (badge) {
                    badge.textContent = data.stock_actual || '0';
                }
            }
        }

        document.getElementById('saveProduct').addEventListener('click', async function() {
            const productForm = document.getElementById('productForm');
            const formData = new FormData(productForm);

            // Validar campos requeridos
            const requiredFields = ['nombre', 'categoria', 'precio_unitario', 'stock_minimo'];
            let hasError = false;
            
            requiredFields.forEach(field => {
                const inputElement = document.getElementById(`id_${field}`);
                if (!inputElement || !inputElement.value || inputElement.value.trim() === '') {
                    hasError = true;
                    if (inputElement) {
                        inputElement.classList.add('is-invalid');
                    }
                } else {
                    if (inputElement) {
                        inputElement.classList.remove('is-invalid');
                    }
                }
            });

            if (hasError) {
                Swal.fire('Error', 'Por favor, complete todos los campos requeridos.', 'error');
                return;
            }

            const url = productForm.action;
            const method = url.includes('/editar/') ? 'POST' : 'POST'; // Ambos son POST en Django

            // Convertir FormData a JSON para la funci贸n AJAX de creaci贸n/edici贸n
            const dataJson = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(url, { 
                    method: method, 
                    body: JSON.stringify(dataJson), 
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                const isUpdate = url.includes('/editar/');

                if (response.ok) {
                    const savedData = await response.json();
                    productModal.hide();
                    await Swal.fire('隆xito!', `Producto ${isUpdate ? 'actualizado' : 'creado'} correctamente.`, 'success');
                    
                    if (isUpdate) {
                        // Recarga solo los detalles del producto editado (usando la funci贸n loadProductDetails que ya llama a /lotes/json/)
                        loadProductDetails(savedData.id);
                    } else {
                        // Si es nuevo, recarga la p谩gina para que aparezca en el listado izquierdo y en el select de categor铆a.
                        location.reload(); 
                    }
                }
                else {
                    const errorData = await response.json();
                    // L贸gica mejorada para mostrar errores de formulario
                    let errorText = 'Error desconocido. Revise la consola.';
                    if (errorData.errors) {
                         // Asume que la respuesta JSON de Django (con errores de form) se maneja
                         errorText = Object.entries(errorData.errors).map(([field, msgs]) => {
                             return `**${field}:** ${msgs.join(', ')}`;
                         }).join('<br>');
                    } else if (errorData.error) {
                        errorText = errorData.error;
                    }
                    Swal.fire('Error de Validaci贸n', errorText, 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error de Red', 'Ocurri贸 un error al intentar guardar el producto.', 'error');
            }
        });

        productList.addEventListener('click', function(e) {
            const target = e.target.closest('.product-item');
            if (target) {
                e.preventDefault();
                const currentActive = document.querySelector('.product-item.active');
                if (currentActive) {
                    currentActive.classList.remove('active');
                }
                target.classList.add('active');
                loadProductDetails(target.dataset.productId);
            }
        });

        function filterProducts() {
            const searchText = productSearch.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const selectedStockLevel = stockLevelFilter.value;

            document.querySelectorAll('#product-list .product-item').forEach(item => {
                const productName = item.querySelector('h6').textContent.toLowerCase();
                const productCategory = item.getAttribute('data-category');
                const stockActual = parseInt(item.getAttribute('data-stock-actual'));
                const stockMinimo = parseInt(item.getAttribute('data-stock-minimo'));

                const matchesSearch = productName.includes(searchText);
                const matchesCategory = selectedCategory === 'all' || selectedCategory === productCategory;
                
                let matchesStockLevel = true;
                if (selectedStockLevel === 'low') {
                    matchesStockLevel = stockActual <= stockMinimo && stockActual > 0;
                } else if (selectedStockLevel === 'out') {
                    matchesStockLevel = stockActual === 0;
                }

                if (matchesSearch && matchesCategory && matchesStockLevel) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        productSearch.addEventListener('keyup', filterProducts);
        categoryFilter.addEventListener('change', filterProducts);
        stockLevelFilter.addEventListener('change', filterProducts);

        const newProductBtn = document.querySelector('[data-bs-target="#productModal"]');
        if(newProductBtn) {
            newProductBtn.addEventListener('click', function() {
                openProductModal('new');
            });
        }

        // AJAX para crear nueva categor铆a
        guardarCategoriaBtn.addEventListener('click', async function() {
            const nombreCategoria = nombreCategoriaInput.value.trim();
            if (!nombreCategoria) {
                Swal.fire('Error', 'Por favor, ingrese un nombre de categor铆a.', 'error');
                return;
            }

            try {
                const response = await fetch("{% url 'inventory:categoria_create' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ nombre: nombreCategoria })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Crear una nueva opci贸n y agregarla al select
                    const select = document.getElementById('id_categoria');
                    const option = new Option(data.nombre, data.id);
                    select.add(option);
                    // Seleccionar la nueva categor铆a
                    select.value = data.id;
                    // Limpiar y cerrar el modal
                    nombreCategoriaInput.value = '';
                    nuevaCategoriaModal.hide();
                    Swal.fire('隆xito!', 'Categor铆a creada correctamente.', 'success');
                } else {
                    const errorData = await response.json();
                    let errorText = 'Error desconocido al crear la categor铆a.';
                    if (errorData.errors) {
                        errorText = Object.values(errorData.errors).flat().join('<br>');
                    } else if (errorData.error) {
                        errorText = errorData.error;
                    }
                    Swal.fire('Error', errorText, 'error');
                }
            } catch (error) {
                console.error('Error de red al crear categor铆a:', error);
                Swal.fire('Error de Red', 'Ocurri贸 un error al intentar crear la categor铆a.', 'error');
            }
        });

        // Initialize stock bars
        document.querySelectorAll('.product-item').forEach(item => {
            const stockBar = item.querySelector('.stock-bar');
            const stockActual = parseInt(item.dataset.stockActual);
            const stockMinimo = parseInt(item.dataset.stockMinimo);
            
            let percentage = 0;
            if (stockMinimo > 0) {
                percentage = (stockActual / stockMinimo) * 100;
            } else if (stockActual > 0) {
                percentage = 100;
            }

            if (percentage > 100) percentage = 100;

            stockBar.style.width = percentage + '%';

            if (stockActual === 0) {
                stockBar.classList.add('empty');
            } else if (stockActual <= stockMinimo) {
                stockBar.classList.add('low');
            }
        });
    });
</script>
{% endblock %}
