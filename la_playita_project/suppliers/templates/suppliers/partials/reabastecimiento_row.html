{% load reabastecimiento_extras %}
{% load humanize %}
{% load currency_format %}

{% with total_detalles=r.reabastecimientodetalle_set.count %}
<tr id="reabastecimiento-row-{{ r.id }}" class="reabastecimiento-row" data-reabastecimiento-id="{{ r.id }}" data-estado="{{ r.estado }}">
    <td class="ps-3">
        <div class="fw-bold text-primary">
            <i class="fas fa-building me-1"></i>{{ r.proveedor.nombre_empresa }}
        </div>
        <small class="text-muted d-block mt-1">
            <i class="fas fa-calendar me-1"></i>{{ r.fecha|date:"d/m/Y H:i" }}
        </small>
    </td>
    <td class="text-center">
        <span class="badge {% if r.estado == 'solicitado' %}bg-warning text-dark{% elif r.estado == 'recibido' %}bg-success{% else %}bg-danger{% endif %}" title="Estado: {{ r.estado }}" style="font-size: 0.9rem; padding: 0.5rem 0.75rem; font-weight: 700;">
            {% if r.estado == 'solicitado' %}<i class="fas fa-hourglass-half me-1"></i>{% elif r.estado == 'recibido' %}<i class="fas fa-check-circle me-1"></i>{% else %}<i class="fas fa-ban me-1"></i>{% endif %}
            {% get_estado_reabastecimiento_display r.estado %}
        </span>
    </td>
    <td class="text-center">
        <!-- Barra de progreso con indicador visual -->
        <div class="progress-mini" style="height: 24px; display: flex; align-items: center; gap: 0.5rem;">
            <div class="progress flex-grow-1" style="height: 6px; min-width: 80px; border-radius: 3px; overflow: hidden;">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: 0%; transition: width 0.3s ease;" 
                     aria-valuenow="0" 
                     aria-valuemin="0" aria-valuemax="100"
                     data-reabastecimiento-id="{{ r.id }}"
                     aria-label="Progreso de recepción">
                </div>
            </div>
            <small class="text-muted fw-bold" style="min-width: 50px; text-align: right; font-size: 0.85rem;" 
                   data-progress-text="{{ r.id }}"
                   aria-live="polite"
                   aria-atomic="true">
                0/{{ total_detalles }}
            </small>
        </div>
    </td>
    <td class="text-center">
        <div style="font-size: 0.85rem;">
            <div class="mb-1">
                <small class="text-muted d-block">Subtotal</small>
                <span class="badge bg-info text-white" title="Costo total sin IVA">
                    <i class="fas fa-calculator me-1"></i>{{ r.costo_total|default:"0"|currency }}
                </span>
            </div>
            <div class="mb-1">
                <small class="text-muted d-block">IVA</small>
                <span class="badge bg-warning text-dark" title="Impuesto al valor agregado">
                    <i class="fas fa-percent me-1"></i>{{ r.iva|default:"0"|currency }}
                </span>
            </div>
            <div>
                <small class="text-muted d-block">Total</small>
                <span class="badge bg-success text-white" title="Total con IVA" style="font-weight: 700;">
                    <i class="fas fa-money-bill me-1"></i>{{ r.costo_total|add:r.iva|default:"0"|currency }}
                </span>
            </div>
        </div>
    </td>
    <td class="text-center">
        <div class="btn-group btn-group-sm" role="group" aria-label="Acciones para orden {{ r.id }}">
            {% if r.estado == 'solicitado' %}
                <button type="button" class="btn btn-success btn-recibir" data-id="{{ r.id }}" title="Recibir esta orden" aria-label="Recibir orden {{ r.id }}" style="font-weight: 600;">
                    <i class="fas fa-truck-loading me-1"></i><span class="d-none d-lg-inline">Recibir</span>
                </button>
                <button type="button" class="btn btn-outline-primary btn-editar" data-id="{{ r.id }}" title="Editar orden" aria-label="Editar orden {{ r.id }}">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-eliminar" data-id="{{ r.id }}" title="Eliminar orden" aria-label="Eliminar orden {{ r.id }}">
                    <i class="fas fa-trash"></i>
                </button>
            {% elif r.estado == 'recibido' %}
                <button type="button" class="btn btn-info btn-ver-detalles" data-id="{{ r.id }}" title="Ver detalles" aria-label="Ver detalles de orden {{ r.id }}">
                    <i class="fas fa-eye me-1"></i><span class="d-none d-lg-inline">Ver</span>
                </button>
                <button type="button" class="btn btn-outline-info btn-ver-auditoria" data-id="{{ r.id }}" title="Ver historial de cambios" aria-label="Ver auditoría de orden {{ r.id }}">
                    <i class="fas fa-history"></i>
                </button>
            {% else %}
                <button type="button" class="btn btn-secondary btn-ver-detalles" data-id="{{ r.id }}" title="Ver detalles" aria-label="Ver detalles de orden {{ r.id }}">
                    <i class="fas fa-eye me-1"></i><span class="d-none d-lg-inline">Ver</span>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-ver-auditoria" data-id="{{ r.id }}" title="Ver historial de cambios" aria-label="Ver auditoría de orden {{ r.id }}">
                    <i class="fas fa-history"></i>
                </button>
            {% endif %}
        </div>
    </td>
</tr>
{% endwith %}