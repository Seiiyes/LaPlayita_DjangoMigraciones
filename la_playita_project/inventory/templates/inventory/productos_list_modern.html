{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Productos - Inventario{% endblock %}

{% block extra_css %}
<style>
    .filter-sidebar {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: sticky;
        top: 20px;
    }
    .product-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s;
        cursor: pointer;
    }
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        background: #f8f9fa;
    }
    .stock-badge {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .estado-normal { color: #28a745; }
    .estado-bajo { color: #ffc107; }
    .estado-critico { color: #dc3545; }
    .estado-sin { color: #6c757d; }
    .filter-chip {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        background: #e9ecef;
        margin: 0.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .filter-chip:hover {
        background: #dee2e6;
    }
    .filter-chip.active {
        background: #0d6efd;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">üì¶ Gesti√≥n de Productos</h2>
            <p class="text-muted mb-0">Administra tu inventario de productos</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="exportarExcel()">
                <i class="bi bi-file-earmark-excel"></i> Exportar
            </button>
            <a href="{% url 'inventory:producto_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Nuevo Producto
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar de Filtros -->
        <div class="col-lg-3">
            <div class="filter-sidebar">
                <h5 class="mb-3">üîç Filtros</h5>
                
                <!-- B√∫squeda -->
                <div class="mb-3">
                    <label class="form-label small text-muted">Buscar</label>
                    <input type="text" class="form-control" id="search-input" placeholder="Nombre o c√≥digo...">
                </div>

                <!-- Categor√≠a -->
                <div class="mb-3">
                    <label class="form-label small text-muted">Categor√≠a</label>
                    <select class="form-select" id="categoria-filter">
                        <option value="">Todas</option>
                    </select>
                </div>

                <!-- Estado de Stock -->
                <div class="mb-3">
                    <label class="form-label small text-muted">Estado de Stock</label>
                    <div id="estado-stock-filters">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="NORMAL" id="check-normal" checked>
                            <label class="form-check-label" for="check-normal">
                                <span class="estado-normal">‚óè</span> Normal
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="STOCK_BAJO" id="check-bajo" checked>
                            <label class="form-check-label" for="check-bajo">
                                <span class="estado-bajo">‚óè</span> Stock Bajo
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="STOCK_CRITICO" id="check-critico" checked>
                            <label class="form-check-label" for="check-critico">
                                <span class="estado-critico">‚óè</span> Stock Cr√≠tico
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="SIN_STOCK" id="check-sin" checked>
                            <label class="form-check-label" for="check-sin">
                                <span class="estado-sin">‚óè</span> Sin Stock
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Ordenar por -->
                <div class="mb-3">
                    <label class="form-label small text-muted">Ordenar por</label>
                    <select class="form-select" id="ordenar-filter">
                        <option value="nombre">Nombre (A-Z)</option>
                        <option value="-nombre">Nombre (Z-A)</option>
                        <option value="stock_actual">Stock (Menor a Mayor)</option>
                        <option value="-stock_actual">Stock (Mayor a Menor)</option>
                        <option value="precio_unitario">Precio (Menor a Mayor)</option>
                        <option value="-precio_unitario">Precio (Mayor a Menor)</option>
                    </select>
                </div>

                <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                </button>
            </div>
        </div>

        <!-- Lista de Productos -->
        <div class="col-lg-9">
            <!-- Vista de Resumen -->
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="mb-0" id="total-mostrados">0</h3>
                            <small class="text-muted">Productos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="mb-0 text-success" id="valor-total">$0</h3>
                            <small class="text-muted">Valor Total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="mb-0 text-warning" id="alertas-count">0</h3>
                            <small class="text-muted">Con Alertas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary active" onclick="cambiarVista('grid')">
                                    <i class="bi bi-grid-3x3-gap"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="cambiarVista('list')">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenedor de Productos -->
            <div id="productos-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3 text-muted">Cargando productos...</p>
                </div>
            </div>

            <!-- Paginaci√≥n -->
            <nav aria-label="Paginaci√≥n" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination-container">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Modal Detalle Producto -->
<div class="modal fade" id="productoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalLabel">Detalle del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productoModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};
let vistaActual = 'grid';

// Cargar categor√≠as
async function cargarCategorias() {
    try {
        const response = await fetch('/api/inventory/categorias/');
        const data = await response.json();
        
        const select = document.getElementById('categoria-filter');
        data.results.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.nombre;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando categor√≠as:', error);
    }
}

// Cargar productos
async function cargarProductos(page = 1) {
    try {
        const params = new URLSearchParams({
            page: page,
            ...currentFilters
        });
        
        const response = await fetch(`/api/inventory/productos/?${params}`);
        const data = await response.json();
        
        mostrarProductos(data.results);
        actualizarResumen(data);
        actualizarPaginacion(data);
        
    } catch (error) {
        console.error('Error cargando productos:', error);
        document.getElementById('productos-container').innerHTML = 
            '<div class="alert alert-danger">Error al cargar productos</div>';
    }
}

// Mostrar productos
function mostrarProductos(productos) {
    const container = document.getElementById('productos-container');
    
    if (productos.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="mt-3 text-muted">No se encontraron productos</p>
            </div>
        `;
        return;
    }
    
    if (vistaActual === 'grid') {
        container.innerHTML = `
            <div class="row g-3">
                ${productos.map(producto => `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card" onclick="verDetalle(${producto.id})">
                            <div class="d-flex gap-3">
                                <img src="${producto.imagen_url || '/static/img/no-image.png'}" 
                                     class="product-image" alt="${producto.nombre}">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${producto.nombre}</h6>
                                    <small class="text-muted">${producto.categoria_nombre}</small>
                                    <div class="mt-2">
                                        <span class="stock-badge estado-${getEstadoClass(producto.estado_stock)}">
                                            ${producto.stock_actual}
                                        </span>
                                        <small class="text-muted">/ ${producto.stock_minimo}</small>
                                    </div>
                                    <div class="mt-2">
                                        <strong class="text-success">$${producto.precio_unitario.toLocaleString('es-CO')}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th>Valor</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productos.map(producto => `
                            <tr onclick="verDetalle(${producto.id})" style="cursor: pointer;">
                                <td>
                                    <strong>${producto.nombre}</strong>
                                    ${producto.codigo_barras ? `<br><small class="text-muted">${producto.codigo_barras}</small>` : ''}
                                </td>
                                <td>${producto.categoria_nombre}</td>
                                <td>
                                    <span class="badge bg-${getEstadoBadge(producto.estado_stock)}">
                                        ${producto.stock_actual} / ${producto.stock_minimo}
                                    </span>
                                </td>
                                <td>$${producto.precio_unitario.toLocaleString('es-CO')}</td>
                                <td>$${producto.valor_inventario.toLocaleString('es-CO')}</td>
                                <td><span class="badge bg-secondary">${producto.estado_stock}</span></td>
                                <td onclick="event.stopPropagation();">
                                    <a href="/inventory/producto/${producto.id}/editar/" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
}

// Helpers
function getEstadoClass(estado) {
    const map = {
        'NORMAL': 'normal',
        'STOCK_BAJO': 'bajo',
        'STOCK_CRITICO': 'critico',
        'SIN_STOCK': 'sin'
    };
    return map[estado] || 'normal';
}

function getEstadoBadge(estado) {
    const map = {
        'NORMAL': 'success',
        'STOCK_BAJO': 'warning',
        'STOCK_CRITICO': 'danger',
        'SIN_STOCK': 'secondary'
    };
    return map[estado] || 'secondary';
}

// Actualizar resumen
function actualizarResumen(data) {
    document.getElementById('total-mostrados').textContent = data.count || 0;
    
    const valorTotal = data.results.reduce((sum, p) => sum + parseFloat(p.valor_inventario || 0), 0);
    document.getElementById('valor-total').textContent = '$' + valorTotal.toLocaleString('es-CO');
    
    const conAlertas = data.results.filter(p => p.estado_stock !== 'NORMAL').length;
    document.getElementById('alertas-count').textContent = conAlertas;
}

// Actualizar paginaci√≥n
function actualizarPaginacion(data) {
    const container = document.getElementById('pagination-container');
    const totalPages = Math.ceil(data.count / 25);
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Anterior
    html += `
        <li class="page-item ${!data.previous ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cargarProductos(${currentPage - 1}); return false;">Anterior</a>
        </li>
    `;
    
    // P√°ginas
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="cargarProductos(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // Siguiente
    html += `
        <li class="page-item ${!data.next ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cargarProductos(${currentPage + 1}); return false;">Siguiente</a>
        </li>
    `;
    
    container.innerHTML = html;
}

// Ver detalle
async function verDetalle(id) {
    const modal = new bootstrap.Modal(document.getElementById('productoModal'));
    modal.show();
    
    try {
        const response = await fetch(`/api/inventory/productos/${id}/`);
        const producto = await response.json();
        
        document.getElementById('productoModalBody').innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <img src="${producto.imagen_url || '/static/img/no-image.png'}" 
                         class="img-fluid rounded" alt="${producto.nombre}">
                </div>
                <div class="col-md-8">
                    <h4>${producto.nombre}</h4>
                    <p class="text-muted">${producto.descripcion || 'Sin descripci√≥n'}</p>
                    
                    <div class="row g-3 mt-3">
                        <div class="col-6">
                            <small class="text-muted">Stock Actual</small>
                            <h5>${producto.stock_actual}</h5>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Stock M√≠nimo</small>
                            <h5>${producto.stock_minimo}</h5>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Precio</small>
                            <h5>$${producto.precio_unitario.toLocaleString('es-CO')}</h5>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Costo Promedio</small>
                            <h5>$${producto.costo_promedio.toLocaleString('es-CO')}</h5>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <a href="/inventory/producto/${producto.id}/editar/" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="/inventory/producto/${producto.id}/kardex/" class="btn btn-outline-secondary">
                            <i class="bi bi-file-text"></i> Ver Kardex
                        </a>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error cargando detalle:', error);
    }
}

// Cambiar vista
function cambiarVista(vista) {
    vistaActual = vista;
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
    event.target.closest('button').classList.add('active');
    cargarProductos(currentPage);
}

// Aplicar filtros
function aplicarFiltros() {
    currentFilters = {};
    
    const search = document.getElementById('search-input').value;
    if (search) currentFilters.search = search;
    
    const categoria = document.getElementById('categoria-filter').value;
    if (categoria) currentFilters.categoria = categoria;
    
    const estadosChecked = Array.from(document.querySelectorAll('#estado-stock-filters input:checked'))
        .map(cb => cb.value);
    if (estadosChecked.length > 0 && estadosChecked.length < 4) {
        currentFilters.estado_stock = estadosChecked.join(',');
    }
    
    const ordenar = document.getElementById('ordenar-filter').value;
    if (ordenar) currentFilters.ordering = ordenar;
    
    currentPage = 1;
    cargarProductos(1);
}

// Limpiar filtros
function limpiarFiltros() {
    document.getElementById('search-input').value = '';
    document.getElementById('categoria-filter').value = '';
    document.getElementById('ordenar-filter').value = 'nombre';
    document.querySelectorAll('#estado-stock-filters input').forEach(cb => cb.checked = true);
    currentFilters = {};
    cargarProductos(1);
}

// Exportar a Excel
async function exportarExcel() {
    try {
        // Mostrar loading
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando...';
        btn.disabled = true;
        
        // Construir URL con filtros actuales
        const params = new URLSearchParams(currentFilters);
        const url = `/inventory/productos/exportar/?${params}`;
        
        // Hacer fetch para verificar que la respuesta sea correcta
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        // Verificar que sea un archivo Excel
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('spreadsheetml')) {
            // Si no es Excel, probablemente sea un error en HTML
            const text = await response.text();
            console.error('Respuesta no es Excel:', text);
            throw new Error('El servidor no devolvi√≥ un archivo Excel v√°lido');
        }
        
        // Crear blob y descargar
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `productos_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Limpiar URL
        window.URL.revokeObjectURL(downloadUrl);
        
        // Mostrar mensaje de √©xito
        mostrarToast('Archivo Excel descargado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error al exportar:', error);
        mostrarToast(`Error al exportar: ${error.message}`, 'danger');
    } finally {
        // Restaurar bot√≥n
        const btn = document.querySelector('button[onclick="exportarExcel()"]');
        if (btn) {
            btn.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Exportar';
            btn.disabled = false;
        }
    }
}

// Funci√≥n helper para mostrar toasts
function mostrarToast(mensaje, tipo = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${tipo} border-0 position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    
    const icon = tipo === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi ${icon} me-2"></i>
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remover toast despu√©s de que se oculte
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    cargarCategorias();
    cargarProductos();
    
    // B√∫squeda con debounce
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(aplicarFiltros, 500);
    });
    
    // Otros filtros
    document.getElementById('categoria-filter').addEventListener('change', aplicarFiltros);
    document.getElementById('ordenar-filter').addEventListener('change', aplicarFiltros);
    document.querySelectorAll('#estado-stock-filters input').forEach(cb => {
        cb.addEventListener('change', aplicarFiltros);
    });
});
</script>
{% endblock %}
