{# Inline Reception Form - Improved with live validation #}
<div class="reception-mode-container d-flex flex-column h-100">
    <!-- Header: Sticky -->
    <div class="reception-header sticky-top bg-white p-3 mb-3 border-bottom shadow-sm" style="margin: -1rem -1rem 0 -1rem; padding: 1rem !important;" role="region" aria-label="Encabezado de recepción">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <h5 class="mb-0">
                    <i class="fas fa-truck-loading text-success me-2"></i>
                    Recibir Orden #<span id="receptionOrderId" class="fw-bold text-primary" aria-live="polite"></span>
                </h5>
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-building me-1"></i>
                    <span id="receptionProveedorName" aria-live="polite">Cargando...</span>
                </small>
            </div>
            <button type="button" class="btn btn-close" id="cancelReceptionBtn" aria-label="Cerrar recepción (Esc)" title="Presiona Esc para cerrar"></button>
        </div>
        
        <!-- Quick Actions -->
        <div class="d-flex flex-wrap gap-2 mt-2">
            <button type="button" class="btn btn-sm btn-success" id="markAllReceivedBtn" title="Llenar con cantidad solicitada (Ctrl+A)" aria-label="Marcar todos los productos como recibidos">
                <i class="fas fa-check-double me-1"></i> Marcar todo
            </button>
            <div class="input-group input-group-sm" style="max-width: 280px;">
                <input type="date" class="form-control form-control-sm" id="generalExpiryDate" name="generalExpiryDate" title="Aplicar fecha a todos" aria-label="Fecha de caducidad a aplicar a todos">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="applyGeneralExpiryBtn" title="Aplicar fecha de caducidad a todos" aria-label="Aplicar fecha de caducidad a todos los productos">
                    <i class="fas fa-calendar-alt me-1"></i> Aplicar
                </button>
            </div>
            <div class="input-group input-group-sm" style="max-width: 200px;">
                <input type="text" class="form-control form-control-sm" id="searchProductInput" name="searchProductInput" placeholder="Buscar producto..." autocomplete="off" aria-label="Buscar producto en la tabla">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearSearchBtn" title="Limpiar búsqueda" aria-label="Limpiar búsqueda de productos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <small class="text-muted ms-auto align-self-center d-none d-lg-block">
                <kbd>Ctrl+Enter</kbd> confirma | <kbd>Esc</kbd> cancela
            </small>
        </div>
    </div>

    <!-- Reception Table: Scrollable -->
    <form id="receptionForm" class="flex-grow-1 d-flex flex-column">
        <div class="table-responsive flex-grow-1" style="overflow-y: auto;">
            <table class="table table-sm table-hover mb-0" role="grid" aria-label="Tabla de recepción de mercancía">
                <thead class="table-light sticky-top" style="top: 0; z-index: 10;">
                    <tr role="row">
                        <th style="width: 28%;" role="columnheader">Producto</th>
                        <th class="text-center" style="width: 10%;" role="columnheader">Solicitado</th>
                        <th class="text-center" style="width: 16%;" role="columnheader">Recibido</th>
                        <th class="text-center" style="width: 20%;" role="columnheader">Caducidad</th>
                        <th class="text-center" style="width: 14%;" role="columnheader">Estado</th>
                        <th class="text-center" style="width: 12%;" role="columnheader">Acción</th>
                    </tr>
                </thead>
                <tbody id="receptionTableBody">
                    {# Rows will be populated by JavaScript #}
                </tbody>
                <tfoot class="table-light" style="position: sticky; bottom: 0; z-index: 5;">
                    <tr>
                        <td colspan="6" class="text-end small text-muted p-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Usa Tab para navegar | Ctrl+Enter para confirmar
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Summary & Progress: Sticky Bottom -->
        <div class="reception-footer sticky-bottom bg-light p-3 mt-3 border-top" style="margin: 0 -1rem -1rem -1rem; padding: 1rem !important;">
            <!-- Progress Bar -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="fw-bold text-muted">Progreso</small>
                    <small class="text-muted" id="progressText" aria-live="polite" aria-atomic="true">0 de 0</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso de recepción"></div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="row g-2 mb-3">
                <div class="col-4">
                    <div class="p-3 bg-success bg-opacity-10 rounded border border-success" role="status" aria-label="Productos completos">
                        <small class="text-muted d-block mb-1"><i class="fas fa-check-circle text-success me-1"></i>Completos</small>
                        <strong class="fs-5 text-success" id="completedCount" aria-live="polite" aria-atomic="true">0</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning" role="status" aria-label="Productos parciales">
                        <small class="text-muted d-block mb-1"><i class="fas fa-exclamation-circle text-warning me-1"></i>Parciales</small>
                        <strong class="fs-5 text-warning" id="partialCount" aria-live="polite" aria-atomic="true">0</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-3 bg-danger bg-opacity-10 rounded border border-danger" role="status" aria-label="Productos pendientes">
                        <small class="text-muted d-block mb-1"><i class="fas fa-clock text-danger me-1"></i>Pendientes</small>
                        <strong class="fs-5 text-danger" id="pendingCount" aria-live="polite" aria-atomic="true">0</strong>
                    </div>
                </div>
            </div>

            <!-- Validation Alert -->
            <div id="validationAlert" class="alert alert-danger alert-sm mb-3" role="alert" aria-live="polite" aria-atomic="true" style="display: none;">
                <small id="validationAlertText"></small>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" id="cancelReceptionBtn2" aria-label="Cancelar recepción (Esc)">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success flex-grow-1" id="confirmReceptionBtn" disabled aria-label="Confirmar recepción de mercancía (Ctrl+Enter)" title="Completa todos los productos para confirmar">
                    <i class="fas fa-check me-2"></i> Confirmar Recepción
                </button>
            </div>
        </div>
    </form>
</div>
