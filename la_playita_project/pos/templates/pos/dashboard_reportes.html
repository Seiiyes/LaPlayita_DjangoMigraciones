{% extends "core/base.html" %}
{% load static %}

{% block title %}Dashboard - La Playita{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 2rem 0;
    }
    
    /* Accesos Rápidos */
    .quick-access-card {
        border: none;
        border-radius: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        text-decoration: none;
        display: block;
        color: white !important;
    }
    
    .quick-access-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        color: white !important;
    }
    
    .quick-access-card .card-body {
        padding: 2rem;
        text-align: center;
        color: white !important;
    }
    
    .quick-access-card i {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        display: block;
        color: white !important;
    }
    
    .quick-access-card h5 {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: white !important;
    }
    
    .quick-access-card small {
        display: block;
        color: rgba(255, 255, 255, 0.9) !important;
    }
    
    /* KPIs */
    .kpi-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        height: 100%;
        position: relative;
        color: white;
    }
    
    .kpi-card .card-body {
        padding: 1.5rem;
        position: relative;
        z-index: 1;
    }
    
    .kpi-icon {
        position: absolute;
        right: 1rem;
        top: 1rem;
        font-size: 3rem;
        opacity: 0.2;
    }
    
    .kpi-label {
        font-size: 0.875rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .kpi-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .kpi-detail {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    /* Alertas */
    .alert-card {
        border: none;
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .alert-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    /* Gráficas */
    .chart-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        padding: 1rem;
    }
    
    /* Rankings */
    .ranking-table {
        margin-bottom: 0;
    }
    
    .ranking-table td, .ranking-table th {
        padding: 0.75rem;
        vertical-align: middle;
    }
    
    .badge-rank {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .badge-rank.gold {
        background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        color: white;
    }
    
    .badge-rank.silver {
        background: linear-gradient(135deg, #bdc3c7 0%, #ecf0f1 100%);
        color: #2c3e50;
    }
    
    .badge-rank.bronze {
        background: linear-gradient(135deg, #cd7f32 0%, #d4a574 100%);
        color: white;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: #667eea;
        color: white;
    }
    
    .accordion-button:focus {
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">
    <!-- Header estilo POS -->
    <div class="pos-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-1"><i class="bi bi-house-door me-2"></i>Panel Principal</h3>
                <p class="text-muted mb-0">
                    Bienvenido, {{ request.user.first_name|default:request.user.username }}
                    {% if es_vendedor %}
                    <span class="badge bg-info ms-2">Vendedor</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{% url 'pos:pos_view' %}" class="btn btn-outline-primary">
                    <i class="bi bi-cash-register me-1"></i>Nueva Venta
                </a>
            </div>
        </div>
    </div>

    {% if es_vendedor %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Nota:</strong> Estás viendo únicamente tus métricas y ventas personales.
    </div>
    {% endif %}

    <!-- SECCIÓN 1: ACCESOS RÁPIDOS -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <a href="{% url 'pos:pos_view' %}" class="card quick-access-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="card-body">
                    <i class="bi bi-cart3"></i>
                    <h5>Punto de Venta</h5>
                    <small>Iniciar nueva venta</small>
                </div>
            </a>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <a href="{% url 'inventory:productos_list' %}" class="card quick-access-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body">
                    <i class="bi bi-box-seam"></i>
                    <h5>Inventario</h5>
                    <small>{{ total_productos }} productos</small>
                </div>
            </a>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <a href="{% url 'inventory:alertas_stock' %}" class="card quick-access-card" style="background: {% if productos_bajos_stock > 0 %}linear-gradient(135deg, #f093fb 0%, #f5576c 100%){% else %}linear-gradient(135deg, #667eea 0%, #764ba2 100%){% endif %};">
                <div class="card-body">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>Alertas de Stock</h5>
                    <small>{{ productos_bajos_stock }} productos</small>
                </div>
            </a>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <a href="{% url 'clients:cliente_list' %}" class="card quick-access-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="card-body">
                    <i class="bi bi-gift"></i>
                    <h5>Canjeables</h5>
                    <small>{{ total_clientes }} clientes</small>
                </div>
            </a>
        </div>
    </div>

    <!-- SECCIÓN 2: KPIs PRINCIPALES -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body">
                    <i class="bi bi-cash-coin kpi-icon"></i>
                    <div class="kpi-label">Ventas Hoy</div>
                    <div class="kpi-value">${{ total_hoy|floatformat:0 }}</div>
                    <div class="kpi-detail">
                        <i class="bi bi-receipt"></i> {{ cantidad_hoy }} transacciones
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="card-body">
                    <i class="bi bi-calendar-month kpi-icon"></i>
                    <div class="kpi-label">Ventas del Mes</div>
                    <div class="kpi-value">${{ total_30dias|floatformat:0 }}</div>
                    <div class="kpi-detail">
                        {% if crecimiento > 0 %}
                            <i class="bi bi-arrow-up-circle"></i> +{{ crecimiento|floatformat:1 }}%
                        {% elif crecimiento < 0 %}
                            <i class="bi bi-arrow-down-circle"></i> {{ crecimiento|floatformat:1 }}%
                        {% else %}
                            <i class="bi bi-dash-circle"></i> 0%
                        {% endif %}
                        vs anterior
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body">
                    <i class="bi bi-calculator kpi-icon"></i>
                    <div class="kpi-label">Ticket Promedio</div>
                    <div class="kpi-value">${{ ticket_promedio|floatformat:0 }}</div>
                    <div class="kpi-detail">
                        <i class="bi bi-cart"></i> Por transacción
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body">
                    <i class="bi bi-graph-up-arrow kpi-icon"></i>
                    <div class="kpi-label">Margen de Ganancia</div>
                    <div class="kpi-value">{{ margen_porcentaje|floatformat:1 }}%</div>
                    <div class="kpi-detail">
                        <i class="bi bi-currency-dollar"></i> ${{ ganancia_bruta|floatformat:0 }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 3: ALERTAS CRÍTICAS -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card alert-card {% if productos_bajos_stock > 0 %}bg-warning{% else %}bg-success{% endif %} text-white">
                <div class="card-body">
                    <h6 class="mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Stock Bajo</h6>
                    <h3 class="mb-2">{{ productos_bajos_stock }}</h3>
                    {% if lista_productos_stock_bajo %}
                        <div class="mt-3" style="max-height: 120px; overflow-y: auto;">
                            <small class="d-block mb-1 opacity-75">Productos:</small>
                            {% for producto in lista_productos_stock_bajo %}
                                <small class="d-block">• {{ producto.nombre }} ({{ producto.stock_actual }})</small>
                            {% endfor %}
                        </div>
                    {% else %}
                        <small>Todos los productos tienen stock adecuado</small>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card alert-card {% if productos_agotados > 0 %}bg-danger{% else %}bg-success{% endif %} text-white">
                <div class="card-body">
                    <h6 class="mb-2"><i class="bi bi-x-circle me-2"></i>Productos Agotados</h6>
                    <h3 class="mb-2">{{ productos_agotados }}</h3>
                    {% if lista_productos_agotados %}
                        <div class="mt-3" style="max-height: 120px; overflow-y: auto;">
                            <small class="d-block mb-1 opacity-75">Productos:</small>
                            {% for producto in lista_productos_agotados %}
                                <small class="d-block">• {{ producto.nombre }}</small>
                            {% endfor %}
                        </div>
                    {% else %}
                        <small>No hay productos agotados</small>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card alert-card {% if productos_sin_movimiento > 5 %}bg-danger{% elif productos_sin_movimiento > 0 %}bg-warning{% else %}bg-success{% endif %} text-white">
                <div class="card-body">
                    <h6 class="mb-2"><i class="bi bi-pause-circle me-2"></i>Sin Movimiento</h6>
                    <h3 class="mb-2">{{ productos_sin_movimiento }}</h3>
                    {% if lista_productos_sin_movimiento %}
                        <div class="mt-3" style="max-height: 120px; overflow-y: auto;">
                            <small class="d-block mb-1 opacity-75">Productos (30 días):</small>
                            {% for producto in lista_productos_sin_movimiento %}
                                <small class="d-block">• {{ producto.nombre }}</small>
                            {% endfor %}
                        </div>
                    {% else %}
                        <small>Todos los productos tienen movimiento</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 4: GRÁFICAS -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card chart-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-graph-up me-2"></i>Ventas de los Últimos 30 Días
                    </h5>
                    <div class="chart-container">
                        <canvas id="chartVentas30Dias"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card chart-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-trophy me-2"></i>Top 5 Productos
                    </h5>
                    <div class="chart-container">
                        <canvas id="chartTopProductos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 5: RANKINGS -->
    <div class="accordion" id="accordionRankings">
        <!-- Top Productos -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProductos">
                    <i class="bi bi-trophy me-2"></i>Top 5 Productos Más Vendidos
                </button>
            </h2>
            <div id="collapseProductos" class="accordion-collapse collapse" data-bs-parent="#accordionRankings">
                <div class="accordion-body p-0">
                    <div class="table-responsive">
                        <table class="table ranking-table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">#</th>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Ingresos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in top_productos %}
                                <tr>
                                    <td>
                                        <span class="badge-rank {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% else %}bg-secondary text-white{% endif %}">
                                            {{ forloop.counter }}
                                        </span>
                                    </td>
                                    <td>{{ producto.producto__nombre }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ producto.cantidad_total }}</span>
                                    </td>
                                    <td class="text-end fw-bold">${{ producto.ingresos|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Sin datos disponibles</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Vendedores (solo para administradores) -->
        {% if not es_vendedor %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVendedores">
                    <i class="bi bi-person-badge me-2"></i>Top 5 Vendedores
                </button>
            </h2>
            <div id="collapseVendedores" class="accordion-collapse collapse" data-bs-parent="#accordionRankings">
                <div class="accordion-body p-0">
                    <div class="table-responsive">
                        <table class="table ranking-table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">#</th>
                                    <th>Vendedor</th>
                                    <th class="text-center">Ventas</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vendedor in top_vendedores %}
                                <tr>
                                    <td>
                                        <span class="badge-rank {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% else %}bg-secondary text-white{% endif %}">
                                            {{ forloop.counter }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if vendedor.usuario__first_name %}
                                            {{ vendedor.usuario__first_name }} {{ vendedor.usuario__last_name }}
                                        {% else %}
                                            {{ vendedor.usuario__username }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ vendedor.cantidad }}</span>
                                    </td>
                                    <td class="text-end fw-bold">${{ vendedor.total_ventas|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Sin datos disponibles</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Top Clientes -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClientes">
                    <i class="bi bi-people me-2"></i>Top 5 Clientes
                </button>
            </h2>
            <div id="collapseClientes" class="accordion-collapse collapse" data-bs-parent="#accordionRankings">
                <div class="accordion-body p-0">
                    <div class="table-responsive">
                        <table class="table ranking-table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">#</th>
                                    <th>Cliente</th>
                                    <th class="text-center">Compras</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in top_clientes %}
                                <tr>
                                    <td>
                                        <span class="badge-rank {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% else %}bg-secondary text-white{% endif %}">
                                            {{ forloop.counter }}
                                        </span>
                                    </td>
                                    <td>{{ cliente.cliente__nombres }} {{ cliente.cliente__apellidos }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark">{{ cliente.cantidad }}</span>
                                    </td>
                                    <td class="text-end fw-bold">${{ cliente.total_compras|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Sin datos disponibles</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Configuración global
    Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";
    Chart.defaults.color = '#6c757d';
    
    // Gráfico 1: Ventas últimos 30 días (Línea)
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('chartVentas30Dias');
        
        if (!ctx) {
            console.error('Canvas chartVentas30Dias no encontrado');
            return;
        }
        
        // Datos desde el servidor
        const ventasFechas = {{ ventas_fechas_json|safe }};
        const ventasTotales = {{ ventas_totales_json|safe }};
        
        console.log('Fechas:', ventasFechas);
        console.log('Totales:', ventasTotales);
        
        if (ventasFechas.length === 0) {
            const context = ctx.getContext('2d');
            context.font = '14px Arial';
            context.fillStyle = '#6c757d';
            context.textAlign = 'center';
            context.fillText('No hay datos de ventas disponibles', ctx.width / 2, ctx.height / 2);
            return;
        }
        
        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: ventasFechas.map(f => {
                    const date = new Date(f);
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
                }),
                datasets: [{
                    label: 'Ventas',
                    data: ventasTotales,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                return 'Ventas: $' + context.parsed.y.toLocaleString('es-ES');
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-ES');
                            }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    });
    
    // Gráfico 2: Top 5 Productos (Barras Horizontales)
    document.addEventListener('DOMContentLoaded', function() {
        const ctx2 = document.getElementById('chartTopProductos');
        
        if (!ctx2) {
            console.error('Canvas chartTopProductos no encontrado');
            return;
        }
        
        // Datos desde el servidor
        const topProductosData = [
            {% for producto in top_productos %}
            {
                nombre: '{{ producto.producto__nombre|truncatechars:20|escapejs }}',
                cantidad: {{ producto.cantidad_total|default:0 }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        console.log('Top Productos Data:', topProductosData);
        
        if (topProductosData.length === 0) {
            const context = ctx2.getContext('2d');
            context.font = '14px Arial';
            context.fillStyle = '#6c757d';
            context.textAlign = 'center';
            context.fillText('No hay datos disponibles', ctx2.width / 2, ctx2.height / 2);
            return;
        }
        
        const productosNombres = topProductosData.map(p => p.nombre);
        const productosCantidades = topProductosData.map(p => p.cantidad);
        
        new Chart(ctx2.getContext('2d'), {
            type: 'bar',
            data: {
                labels: productosNombres,
                datasets: [{
                    label: 'Cantidad Vendida',
                    data: productosCantidades,
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(17, 153, 142, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        '#667eea',
                        '#11998e',
                        '#f093fb',
                        '#4facfe',
                        '#ffc107'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Vendidos: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
