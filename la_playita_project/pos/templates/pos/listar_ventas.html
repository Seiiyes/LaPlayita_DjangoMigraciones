{% extends "core/base.html" %}
{% block title %}Historial de Ventas - La Playita{% endblock %}

{% block extra_css %}
<style>
    .ventas-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px 15px 0 0;
    }
    .filter-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-card .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    .filter-card .form-control, .filter-card .form-select {
        border-radius: 8px;
        border: 1px solid #ced4da;
        transition: all 0.3s ease;
    }
    .filter-card .form-control:focus, .filter-card .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn-filter {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-clear {
        background: #6c757d;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-clear:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    .ventas-table {
        border-radius: 0 0 15px 15px;
        overflow: hidden;
    }
    .table-ventas {
        margin-bottom: 0;
    }
    .table-ventas thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .table-ventas thead th {
        border: none;
        font-weight: 600;
        padding: 1rem;
    }
    .table-ventas tbody tr {
        transition: all 0.2s ease;
    }
    .table-ventas tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .badge-metodo {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .badge-efectivo { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .badge-tarjeta { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .badge-transferencia { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .badge-cheque { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
    .badge-canal {
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .btn-ver-detalle {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 0.4rem 1rem;
        transition: all 0.3s ease;
    }
    .btn-ver-detalle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    .total-venta {
        font-weight: 700;
        color: #28a745;
        font-size: 1.1rem;
    }
    .empty-state {
        padding: 3rem;
        text-align: center;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    .pagination {
        gap: 0.25rem;
    }
    .pagination .page-link {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        color: #667eea;
        font-weight: 600;
        padding: 0.5rem 0.75rem;
        transition: all 0.3s ease;
    }
    .pagination .page-link:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        transform: translateY(-2px);
    }
    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
    }
    .pagination .page-item.disabled .page-link {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
    }
    .alert-info {
        background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        border: none;
        border-radius: 10px;
        color: #00695c;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header ventas-header text-white">
            <h4 class="mb-0"><i class="bi bi-receipt-cutoff me-2"></i>Historial de Ventas</h4>
        </div>
        <div class="card-body p-4">
            <!-- Filtros -->
            <div class="filter-card">
                <form method="get" id="filtrosForm" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="fecha_desde" class="form-label"><i class="bi bi-calendar-range me-1"></i>Desde</label>
                        <input type="date" id="fecha_desde" name="fecha_desde" class="form-control" value="{{ request.GET.fecha_desde }}">
                    </div>
                    <div class="col-md-2">
                        <label for="fecha_hasta" class="form-label"><i class="bi bi-calendar-range me-1"></i>Hasta</label>
                        <input type="date" id="fecha_hasta" name="fecha_hasta" class="form-control" value="{{ request.GET.fecha_hasta }}">
                    </div>
                    <div class="col-md-3">
                        <label for="metodo_pago" class="form-label"><i class="bi bi-credit-card me-1"></i>MÃ©todo de Pago</label>
                        <select id="metodo_pago" name="metodo_pago" class="form-select">
                            <option value="">Todos</option>
                            <option value="efectivo" {% if request.GET.metodo_pago == "efectivo" %}selected{% endif %}>ğŸ’µ Efectivo</option>
                            <option value="tarjeta_debito" {% if request.GET.metodo_pago == "tarjeta_debito" %}selected{% endif %}>ğŸ’³ Tarjeta DÃ©bito</option>
                            <option value="tarjeta_credito" {% if request.GET.metodo_pago == "tarjeta_credito" %}selected{% endif %}>ğŸ’³ Tarjeta CrÃ©dito</option>
                            <option value="transferencia" {% if request.GET.metodo_pago == "transferencia" %}selected{% endif %}>ğŸ¦ Transferencia</option>
                            <option value="cheque" {% if request.GET.metodo_pago == "cheque" %}selected{% endif %}>ğŸ“ Cheque</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="canal_venta" class="form-label"><i class="bi bi-shop me-1"></i>Canal</label>
                        <select id="canal_venta" name="canal_venta" class="form-select">
                            <option value="">Todos</option>
                            <option value="mostrador" {% if request.GET.canal_venta == "mostrador" %}selected{% endif %}>ğŸª Mostrador</option>
                            <option value="telefono" {% if request.GET.canal_venta == "telefono" %}selected{% endif %}>ğŸ“ TelÃ©fono</option>
                            <option value="online" {% if request.GET.canal_venta == "online" %}selected{% endif %}>ğŸŒ Online</option>
                            <option value="delivery" {% if request.GET.canal_venta == "delivery" %}selected{% endif %}>ğŸšš Delivery</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-filter btn-primary w-100">
                            <i class="bi bi-funnel-fill me-2"></i>Filtrar
                        </button>
                    </div>
                </form>
                <div class="row mt-2">
                    <div class="col-md-9">
                        {% if total_ventas > 0 %}
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Mostrando <strong>{{ ventas|length }}</strong> de <strong>{{ total_ventas }}</strong> ventas
                        </small>
                        {% endif %}
                    </div>
                    <div class="col-md-3 text-end">
                        <a href="{% url 'pos:listar_ventas' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Limpiar filtros
                        </a>
                    </div>
                </div>
            </div>
            <!-- Tabla de Ventas Mejorada -->
            <div class="table-responsive ventas-table">
                <table class="table table-ventas align-middle">
                    <thead>
                        <tr>
                            <th><i class="bi bi-hash me-1"></i>ID</th>
                            <th><i class="bi bi-calendar-event me-1"></i>Fecha y Hora</th>
                            <th><i class="bi bi-person me-1"></i>Cliente</th>
                            <th><i class="bi bi-person-badge me-1"></i>Vendedor</th>
                            <th><i class="bi bi-credit-card me-1"></i>MÃ©todo de Pago</th>
                            <th><i class="bi bi-shop me-1"></i>Canal</th>
                            <th><i class="bi bi-currency-dollar me-1"></i>Total</th>
                            <th class="text-center"><i class="bi bi-gear me-1"></i>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if ventas %}
                            {% for venta in ventas %}
                                <tr>
                                    <td><strong>#{{ venta.id }}</strong></td>
                                    <td>
                                        <div>{{ venta.fecha_venta|date:"d/m/Y" }}</div>
                                        <small class="text-muted">{{ venta.fecha_venta|date:"H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if venta.cliente %}
                                            <i class="bi bi-person-check text-success me-1"></i>
                                            {{ venta.cliente.nombres }} {{ venta.cliente.apellidos }}
                                        {% else %}
                                            <span class="text-muted"><i class="bi bi-person-x me-1"></i>Sin cliente</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <i class="bi bi-person-circle me-1"></i>
                                        {{ venta.usuario.get_full_name|default:venta.usuario.username }}
                                    </td>
                                    <td>
                                        {% if venta.pago_set.all %}
                                            {% with metodo=venta.pago_set.all.0.metodo_pago %}
                                                {% if metodo == "efectivo" %}
                                                    <span class="badge badge-metodo badge-efectivo">ğŸ’µ Efectivo</span>
                                                {% elif metodo == "tarjeta_debito" or metodo == "tarjeta_credito" %}
                                                    <span class="badge badge-metodo badge-tarjeta">ğŸ’³ Tarjeta</span>
                                                {% elif metodo == "transferencia" %}
                                                    <span class="badge badge-metodo badge-transferencia">ğŸ¦ Transferencia</span>
                                                {% elif metodo == "cheque" %}
                                                    <span class="badge badge-metodo badge-cheque">ğŸ“ Cheque</span>
                                                {% else %}
                                                    <span class="badge badge-metodo bg-secondary">{{ metodo|title }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted">â€”</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if venta.canal_venta == "mostrador" %}
                                            <span class="badge badge-canal bg-primary">ğŸª Mostrador</span>
                                        {% elif venta.canal_venta == "telefono" %}
                                            <span class="badge badge-canal bg-info">ğŸ“ TelÃ©fono</span>
                                        {% elif venta.canal_venta == "online" %}
                                            <span class="badge badge-canal bg-success">ğŸŒ Online</span>
                                        {% elif venta.canal_venta == "delivery" %}
                                            <span class="badge badge-canal bg-warning text-dark">ğŸšš Delivery</span>
                                        {% else %}
                                            <span class="badge badge-canal bg-secondary">{{ venta.canal_venta|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="total-venta">${{ venta.total_venta|floatformat:2 }}</span></td>
                                    <td class="text-center">
                                        <a href="{% url 'pos:venta_detalle' venta.id %}" class="btn btn-ver-detalle btn-sm btn-primary" title="Ver Detalle">
                                            <i class="bi bi-eye me-1"></i>Ver
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <h5>No hay ventas registradas</h5>
                                        <p class="text-muted">Las ventas aparecerÃ¡n aquÃ­ una vez que se realicen</p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- PaginaciÃ³n -->
            {% if ventas.has_other_pages %}
            <div class="d-flex justify-content-between align-items-center mt-4 px-3 pb-3">
                <div class="text-muted">
                    PÃ¡gina {{ ventas.number }} de {{ ventas.paginator.num_pages }}
                </div>
                <nav aria-label="PaginaciÃ³n de ventas">
                    <ul class="pagination mb-0">
                        {% if ventas.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" aria-label="Primera">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ ventas.previous_page_number }}" aria-label="Anterior">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                            </li>
                        {% endif %}

                        {% for num in ventas.paginator.page_range %}
                            {% if ventas.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > ventas.number|add:'-3' and num < ventas.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if ventas.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ ventas.next_page_number }}" aria-label="Siguiente">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ ventas.paginator.num_pages }}" aria-label="Ãšltima">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Indicador de filtros activos
    const form = document.getElementById('filtrosForm');
    const inputs = form.querySelectorAll('input[type="date"], select');
    let filtrosActivos = 0;
    
    inputs.forEach(input => {
        if (input.value) {
            filtrosActivos++;
        }
    });
    
    if (filtrosActivos > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge bg-success ms-2';
        badge.textContent = filtrosActivos + ' filtro(s)';
        document.querySelector('.ventas-header h4').appendChild(badge);
    }
});
</script>
{% endblock %}
