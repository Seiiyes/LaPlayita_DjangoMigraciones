{% load tz %}
{% load humanize %}
{% load currency_format %}
{% load number_extras %}
{% load static %}

<div class="card-header bg-primary text-white">
    <h4 class="mb-0">Detalles de Reabastecimiento #{{ reabastecimiento.id }}</h4>
</div>
<div class="card-body">
    <div class="row">
        <div class="col-md-6">
            <p><strong>Proveedor:</strong> {{ reabastecimiento.proveedor.nombre_empresa }}</p>
            <p><strong>Fecha Solicitud:</strong> {{ reabastecimiento.fecha|localtime|date:"d/m/Y H:i" }}</p>
            <p><strong>Estado:</strong>
                {% if reabastecimiento.estado == 'solicitado' %}
                    <span class="badge bg-warning text-dark">{{ reabastecimiento.get_estado_display }}</span>
                {% elif reabastecimiento.estado == 'recibido' %}
                    <span class="badge bg-success">{{ reabastecimiento.get_estado_display }}</span>
                {% elif reabastecimiento.estado == 'cancelado' %}
                    <span class="badge bg-danger">{{ reabastecimiento.get_estado_display }}</span>
                {% else %}
                    <span class="badge bg-info text-dark">{{ reabastecimiento.get_estado_display }}</span>
                {% endif %}
            </p>
            <p><strong>Forma de Pago:</strong> {{ reabastecimiento.get_forma_pago_display }}</p>
            <p><strong>Observaciones:</strong> {{ reabastecimiento.observaciones|default:"N/A" }}</p>
        </div>
        <div class="col-md-6 text-end">
            <h5 class="text-muted">Costo Total: <span class="text-primary">{{ reabastecimiento.costo_total|currency }}</span></h5>
            <h5 class="text-muted">IVA Total: <span class="text-primary">{{ reabastecimiento.iva|currency }}</span></h5>
            {% if reabastecimiento.costo_total and reabastecimiento.iva %}
                <h4 class="text-primary mt-3">Total con IVA: {{ reabastecimiento.costo_total|add:reabastecimiento.iva|currency }}</h4>
            {% endif %}
            <div class="mt-3">
                {% if reabastecimiento.estado == 'solicitado' %}
                    <button type="button" class="btn btn-success btn-sm me-2"
                            data-bs-toggle="modal" data-bs-target="#recibirReabastecimientoModal"
                            data-reabastecimiento-id="{{ reabastecimiento.id }}"
                            title="Recibir esta orden">
                        <i class="fas fa-box-open me-1"></i> Recibir
                    </button>
                    <button type="button" class="btn btn-info btn-sm me-2"
                            data-bs-toggle="modal" data-bs-target="#editarReabastecimientoModal"
                            data-reabastecimiento-id="{{ reabastecimiento.id }}"
                            title="Editar esta orden">
                        <i class="fas fa-edit me-1"></i> Editar
                    </button>
                    {# TODO: Add Cancel/Delete button here if applicable #}
                {% elif reabastecimiento.estado == 'recibido' %}
                    <span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i> Recibida completamente</span>
                {% endif %}
            </div>
        </div>
    </div>

    <hr>

    <h5>Detalles de Productos:</h5>
    <div class="table-responsive">
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th class="text-center">Cant. Solicitada</th>
                    <th class="text-center">Cant. Recibida</th>
                    <th class="text-end">Costo Unitario</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-end">IVA</th>
                    <th class="text-end">Total</th>
                    <th class="text-center">F. Caducidad</th>
                </tr>
            </thead>
            <tbody>
                {% for detalle in reabastecimiento.reabastecimientodetalle_set.all %}
                    <tr>
                        <td>{{ detalle.producto.nombre }}</td>
                        <td class="text-center">{{ detalle.cantidad|intcomma }}</td>
                        <td class="text-center">{{ detalle.cantidad_recibida|intcomma }}</td>
                        <td class="text-end">{{ detalle.costo_unitario|currency }}</td>
                        <td class="text-end">{{ detalle.cantidad|multiply:detalle.costo_unitario|currency }}</td>
                        <td class="text-end">{{ detalle.iva|currency }}</td>
                        <td class="text-end">{{ detalle.cantidad|multiply:detalle.costo_unitario|add:detalle.iva|currency }}</td>
                        <td class="text-center">
                            {% if detalle.fecha_caducidad %}
                                {{ detalle.fecha_caducidad|date:"d/m/Y" }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
